import {
  BadRequestException,
  Body,
  Controller,
  Delete,
  Get,
  HttpCode,
  HttpStatus,
  Logger,
  Param,
  Patch,
  Post,
  Query,
  UseGuards,
} from '@nestjs/common';
import {
  ApiTags,
  ApiOperation,
  ApiResponse,
  ApiBearerAuth,
} from '@nestjs/swagger';
import { AdminService } from './admin.service';
import {
  AdminAuditService,
  AdminCategoryService,
  AdminEventService,
  AdminOrganizationService,
  AdminPaymentService,
  AdminPayoutService,
  AdminRefundService,
  AdminSettingsService,
  AdminUserService,
  AdminVenueCatalogService,
  AdminVenuesService,
  AdminDisputeService,
  AdminFeeScheduleService,
  AdminTaxRateService,
  AdminSessionService,
  AdminWebhookService,
  AdminRevenueService,
  AdminModerationService,
  AdminNotificationService,
  AdminReviewService,
  AdminOrderService,
  AdminTicketService,
  AdminPromotionService,
} from './services';
import { JwtAuthGuard } from '../auth/guards/jwt-auth.guard';
import { RolesGuard } from '../auth/guards/roles.guard';
import { Roles } from '../auth/decorators/roles.decorator';
import { PlatformRole } from '@prisma/client';
import {
  UserQueryDto,
  OrganizationQueryDto,
  EventQueryDto,
  PaymentQueryDto,
  PayoutQueryDto,
  AuditLogQueryDto,
} from './dto/query-params.dto';
import { UpdateUserDto } from './dto/update-user.dto';
import { UpdateOrganizationDto } from './dto/update-organization.dto';
import { UpdateEventStatusDto } from './dto/update-event-status.dto';
import { UpdateSiteSettingsDto } from './dto/site-settings.dto';
import {
  CreateCategoryDto,
  UpdateCategoryDto,
  CategoryQueryDto,
} from './dto/category.dto';
import {
  RefundQueryDto,
  CreateRefundDto,
  UpdateRefundStatusDto,
  ApproveRefundDto,
  RejectRefundDto,
  ProcessRefundDto,
} from './dto/refund.dto';
import { GrantRoleDto, RevokeRoleDto } from './dto/roles.dto';
import {
  OrganizationVerificationQueryDto,
  SubmitForVerificationDto,
  UploadDocumentDto,
  ReviewDocumentDto,
  ApproveOrganizationDto,
  RejectOrganizationDto,
  SuspendOrganizationDto,
  AppealReviewDto,
} from './dto/verification.dto';
import {
  CreateVenueCatalogDto,
  UpdateVenueCatalogDto,
  VenueCatalogImportOptionsDto,
  VenueCatalogQueryDto,
} from './dto/venue-catalog.dto';
import { AdminVenueQueryDto } from './dto/venue-query.dto';
import {
  DisputeQueryDto,
  UpdateDisputeStatusDto,
  RespondToDisputeDto,
  CloseDisputeDto,
} from './dto/dispute.dto';
import {
  FeeScheduleQueryDto,
  CreateFeeScheduleDto,
  UpdateFeeScheduleDto,
  CreateOrgFeeOverrideDto,
  UpdateOrgFeeOverrideDto,
} from './dto/fee-schedule.dto';
import { SessionQueryDto } from './dto/session.dto';
import { WebhookQueryDto, WebhookEventQueryDto } from './dto/webhook.dto';
import { RevenueQueryDto } from './dto/revenue.dto';
import { FlagQueryDto, ResolveFlagDto, ModerationActionQueryDto } from './dto/moderation.dto';
import { NotificationQueryDto, BroadcastNotificationDto } from './dto/notification.dto';
import { ReviewQueryDto } from './dto/review.dto';
import { OrderAdminQueryDto, UpdateOrderStatusDto } from './dto/order.dto';
import { TicketAdminQueryDto, TransferQueryDto, CheckinQueryDto } from './dto/ticket.dto';
import { PromotionQueryDto, PromoCodeQueryDto } from './dto/promotion.dto';
import {
  TaxRateQueryDto,
  CreateTaxRateDto,
  UpdateTaxRateDto,
} from './dto/tax-rate.dto';
import { CurrentUser } from '../auth/decorators/current-user.decorator';
import { UploadedFile, UseInterceptors } from '@nestjs/common';
import { FileInterceptor } from '@nestjs/platform-express';
import * as multer from 'multer';

@ApiTags('Admin')
@Controller('admin')
@UseGuards(JwtAuthGuard, RolesGuard)
@Roles(PlatformRole.admin)
@ApiBearerAuth()
export class AdminController {
  private readonly logger = new Logger(AdminController.name);

  constructor(
    private readonly adminService: AdminService,
    private readonly organizationService: AdminOrganizationService,
    private readonly userService: AdminUserService,
    private readonly eventService: AdminEventService,
    private readonly paymentService: AdminPaymentService,
    private readonly payoutService: AdminPayoutService,
    private readonly refundService: AdminRefundService,
    private readonly categoryService: AdminCategoryService,
    private readonly auditService: AdminAuditService,
    private readonly settingsService: AdminSettingsService,
    private readonly venueCatalogService: AdminVenueCatalogService,
    private readonly venuesAdminService: AdminVenuesService,
    private readonly disputeService: AdminDisputeService,
    private readonly feeScheduleService: AdminFeeScheduleService,
    private readonly taxRateService: AdminTaxRateService,
    private readonly sessionService: AdminSessionService,
    private readonly webhookService: AdminWebhookService,
    private readonly revenueService: AdminRevenueService,
    private readonly moderationService: AdminModerationService,
    private readonly notificationService: AdminNotificationService,
    private readonly reviewService: AdminReviewService,
    private readonly orderService: AdminOrderService,
    private readonly ticketService: AdminTicketService,
    private readonly promotionService: AdminPromotionService,
  ) {}

  // Dashboard Metrics
  @Get('metrics')
  @ApiOperation({ summary: 'Get platform metrics for admin dashboard' })
  @ApiResponse({ status: 200, description: 'Metrics retrieved successfully' })
  async getMetrics() {
    const startTime = Date.now();
    try {
      const data = await this.adminService.getMetrics();
      const duration = Date.now() - startTime;
      this.logger.log(`Admin metrics retrieved in ${duration}ms`);
      return {
        success: true,
        data,
        _meta: { duration },
      };
    } catch (error) {
      const errorMessage =
        error instanceof Error ? error.message : String(error);
      const errorStack = error instanceof Error ? error.stack : undefined;
      this.logger.error(
        `Failed to retrieve admin metrics: ${errorMessage}`,
        errorStack,
      );
      throw error;
    }
  }

  // User Management
  @Get('users')
  @ApiOperation({ summary: 'Get all users with pagination and filters' })
  @ApiResponse({ status: 200, description: 'Users retrieved successfully' })
  async getUsers(@Query() query: UserQueryDto) {
    const result = await this.userService.getUsers(query);
    return {
      success: true,
      data: result,
    };
  }

  @Get('users/:id')
  @ApiOperation({ summary: 'Get user by ID' })
  @ApiResponse({ status: 200, description: 'User retrieved successfully' })
  @ApiResponse({ status: 404, description: 'User not found' })
  async getUser(@Param('id') id: string) {
    const data = await this.userService.getUser(id);
    return {
      success: true,
      data,
    };
  }

  @Patch('users/:id')
  @ApiOperation({ summary: 'Update user' })
  @ApiResponse({ status: 200, description: 'User updated successfully' })
  @ApiResponse({ status: 404, description: 'User not found' })
  async updateUser(@Param('id') id: string, @Body() data: UpdateUserDto) {
    const user = await this.userService.updateUser(id, data);
    return {
      success: true,
      data: user,
      message: 'User updated successfully',
    };
  }

  @Post('users/:id/suspend')
  @HttpCode(HttpStatus.OK)
  @ApiOperation({ summary: 'Suspend user' })
  @ApiResponse({ status: 200, description: 'User suspended successfully' })
  @ApiResponse({ status: 404, description: 'User not found' })
  async suspendUser(@Param('id') id: string) {
    const result = await this.userService.suspendUser(id);
    return {
      success: true,
      data: null,
      ...result,
    };
  }

  @Post('users/:id/activate')
  @HttpCode(HttpStatus.OK)
  @ApiOperation({ summary: 'Activate user' })
  @ApiResponse({ status: 200, description: 'User activated successfully' })
  @ApiResponse({ status: 404, description: 'User not found' })
  async activateUser(@Param('id') id: string) {
    const result = await this.userService.activateUser(id);
    return {
      success: true,
      data: null,
      ...result,
    };
  }

  @Delete('users/:id')
  @ApiOperation({ summary: 'Delete user' })
  @ApiResponse({ status: 200, description: 'User deleted successfully' })
  @ApiResponse({ status: 404, description: 'User not found' })
  async deleteUser(@Param('id') id: string) {
    const result = await this.userService.deleteUser(id);
    return {
      success: true,
      data: null,
      ...result,
    };
  }

  @Post('users/:id/grant-role')
  @HttpCode(HttpStatus.OK)
  @ApiOperation({ summary: 'Grant platform role to a user' })
  @ApiResponse({ status: 200, description: 'Role granted successfully' })
  async grantUserRole(
    @CurrentUser() actor: { id?: string },
    @Param('id') id: string,
    @Body() dto: GrantRoleDto,
  ) {
    const actorId = actor?.id;
    const result = await this.userService.grantPlatformRole(
      id,
      dto.role,
      actorId,
    );
    return {
      success: true,
      data: null,
      ...result,
    };
  }

  @Post('users/:id/revoke-role')
  @HttpCode(HttpStatus.OK)
  @ApiOperation({ summary: 'Revoke platform role from a user' })
  @ApiResponse({ status: 200, description: 'Role revoked successfully' })
  async revokeUserRole(
    @CurrentUser() actor: { id?: string },
    @Param('id') id: string,
    @Body() dto: RevokeRoleDto,
  ) {
    const actorId = actor?.id;
    const fallback = dto?.fallback;
    const result = await this.userService.revokePlatformRole(
      id,
      actorId,
      fallback,
    );
    return {
      success: true,
      data: null,
      ...result,
    };
  }

  // Organization Management
  @Get('organizations')
  @ApiOperation({
    summary: 'Get all organizations with pagination and filters',
  })
  @ApiResponse({
    status: 200,
    description: 'Organizations retrieved successfully',
  })
  async getOrganizations(@Query() query: OrganizationQueryDto) {
    const result = await this.organizationService.getOrganizations(query);
    return {
      success: true,
      data: result,
    };
  }

  @Get('organizations/:id')
  @ApiOperation({ summary: 'Get organization by ID' })
  @ApiResponse({
    status: 200,
    description: 'Organization retrieved successfully',
  })
  @ApiResponse({ status: 404, description: 'Organization not found' })
  async getOrganization(@Param('id') id: string) {
    const data = await this.organizationService.getOrganization(id);
    return {
      success: true,
      data,
    };
  }

  @Patch('organizations/:id')
  @ApiOperation({ summary: 'Update organization' })
  @ApiResponse({
    status: 200,
    description: 'Organization updated successfully',
  })
  @ApiResponse({ status: 404, description: 'Organization not found' })
  async updateOrganization(
    @Param('id') id: string,
    @Body() data: UpdateOrganizationDto,
  ) {
    const organization = await this.organizationService.updateOrganization(
      id,
      data,
    );
    return {
      success: true,
      data: organization,
      message: 'Organization updated successfully',
    };
  }

  // Event Management
  @Get('events')
  @ApiOperation({ summary: 'Get all events with pagination and filters' })
  @ApiResponse({ status: 200, description: 'Events retrieved successfully' })
  async getEvents(@Query() query: EventQueryDto) {
    const startTime = Date.now();
    try {
      const result = await this.eventService.getEvents(query);
      const duration = Date.now() - startTime;
      this.logger.log(
        `Admin events list retrieved in ${duration}ms (page: ${query.page || 1}, limit: ${query.limit || 10})`,
      );
      return {
        success: true,
        data: result,
        _meta: { duration },
      };
    } catch (error) {
      const errorMessage =
        error instanceof Error ? error.message : String(error);
      this.logger.error(`Failed to retrieve admin events: ${errorMessage}`);
      throw error;
    }
  }

  @Get('events/:id')
  @ApiOperation({ summary: 'Get event by ID' })
  @ApiResponse({ status: 200, description: 'Event retrieved successfully' })
  @ApiResponse({ status: 404, description: 'Event not found' })
  async getEvent(@Param('id') id: string) {
    const startTime = Date.now();
    try {
      const data = await this.eventService.getEvent(id);
      const duration = Date.now() - startTime;
      this.logger.log(`Admin event ${id} retrieved in ${duration}ms`);
      return {
        success: true,
        data,
        _meta: { duration },
      };
    } catch (error) {
      const errorMessage =
        error instanceof Error ? error.message : String(error);
      this.logger.error(
        `Failed to retrieve admin event ${id}: ${errorMessage}`,
      );
      throw error;
    }
  }

  @Patch('events/:id/status')
  @ApiOperation({ summary: 'Update event status' })
  @ApiResponse({
    status: 200,
    description: 'Event status updated successfully',
  })
  @ApiResponse({ status: 404, description: 'Event not found' })
  async updateEventStatus(
    @Param('id') id: string,
    @Body() data: UpdateEventStatusDto,
  ) {
    const startTime = Date.now();
    try {
      const result = await this.eventService.updateEventStatus(id, data);
      const duration = Date.now() - startTime;
      this.logger.log(
        `Admin event ${id} status updated to ${data.status} in ${duration}ms`,
      );
      return {
        success: true,
        data: null,
        ...result,
        _meta: { duration },
      };
    } catch (error) {
      const errorMessage =
        error instanceof Error ? error.message : String(error);
      this.logger.error(
        `Failed to update admin event ${id} status to ${data.status}: ${errorMessage}`,
      );
      throw error;
    }
  }

  // Payment Management
  @Get('payments')
  @ApiOperation({ summary: 'Get all payments with pagination and filters' })
  @ApiResponse({ status: 200, description: 'Payments retrieved successfully' })
  async getPayments(@Query() query: PaymentQueryDto) {
    const result = await this.paymentService.getPayments(query);
    return {
      success: true,
      data: result,
    };
  }

  // Payout Management
  @Get('payouts')
  @ApiOperation({ summary: 'Get all payouts with pagination and filters' })
  @ApiResponse({ status: 200, description: 'Payouts retrieved successfully' })
  async getPayouts(@Query() query: PayoutQueryDto) {
    const result = await this.payoutService.getPayouts(query);
    return {
      success: true,
      data: result,
    };
  }

  @Post('payouts/:id/approve')
  @HttpCode(HttpStatus.OK)
  @ApiOperation({ summary: 'Approve payout' })
  @ApiResponse({ status: 200, description: 'Payout approved successfully' })
  @ApiResponse({ status: 404, description: 'Payout not found' })
  async approvePayout(@Param('id') id: string) {
    const result = await this.payoutService.approvePayout(id);
    return {
      success: true,
      data: null,
      ...result,
    };
  }

  // Audit Logs
  @Get('audit-logs')
  @ApiOperation({ summary: 'Get audit logs with pagination and filters' })
  @ApiResponse({
    status: 200,
    description: 'Audit logs retrieved successfully',
  })
  async getAuditLogs(@Query() query: AuditLogQueryDto) {
    const result = await this.auditService.getAuditLogs(query);
    return {
      success: true,
      data: result,
    };
  }

  // Site Settings
  @Get('settings')
  @ApiOperation({ summary: 'Get site settings' })
  @ApiResponse({ status: 200, description: 'Settings retrieved successfully' })
  async getSiteSettings() {
    const data = await this.settingsService.getSiteSettings();
    return {
      success: true,
      data,
    };
  }

  @Patch('settings')
  @ApiOperation({ summary: 'Update site settings' })
  @ApiResponse({ status: 200, description: 'Settings updated successfully' })
  async updateSiteSettings(@Body() settings: UpdateSiteSettingsDto) {
    const data = await this.settingsService.updateSiteSettings(settings);
    return {
      success: true,
      data,
      message: 'Settings updated successfully',
    };
  }

  // Category Management
  @Get('categories')
  @ApiOperation({ summary: 'Get all categories' })
  @ApiResponse({
    status: 200,
    description: 'Categories retrieved successfully',
  })
  async getCategories(@Query() query: CategoryQueryDto) {
    const data = await this.categoryService.getCategories(query);
    return {
      success: true,
      data,
    };
  }

  @Get('categories/:id')
  @ApiOperation({ summary: 'Get category by ID' })
  @ApiResponse({ status: 200, description: 'Category retrieved successfully' })
  async getCategoryById(@Param('id') id: string) {
    const data = await this.categoryService.getCategoryById(id);
    return {
      success: true,
      data,
    };
  }

  @Post('categories')
  @ApiOperation({ summary: 'Create a new category' })
  @ApiResponse({ status: 201, description: 'Category created successfully' })
  async createCategory(@Body() dto: CreateCategoryDto) {
    const data = await this.categoryService.createCategory(dto);
    return {
      success: true,
      data,
      message: 'Category created successfully',
    };
  }

  @Patch('categories/:id')
  @ApiOperation({ summary: 'Update a category' })
  @ApiResponse({ status: 200, description: 'Category updated successfully' })
  async updateCategory(
    @Param('id') id: string,
    @Body() dto: UpdateCategoryDto,
  ) {
    const data = await this.categoryService.updateCategory(id, dto);
    return {
      success: true,
      data,
      message: 'Category updated successfully',
    };
  }

  @Delete('categories/:id')
  @ApiOperation({ summary: 'Delete a category' })
  @ApiResponse({ status: 200, description: 'Category deleted successfully' })
  async deleteCategory(@Param('id') id: string) {
    const data = await this.categoryService.deleteCategory(id);
    return {
      success: true,
      data,
      message: 'Category deleted successfully',
    };
  }

  // Venue Catalog Management
  @Get('venues/catalog')
  @ApiOperation({ summary: 'List venue catalog entries' })
  @ApiResponse({ status: 200, description: 'Catalog entries retrieved' })
  async listVenueCatalog(@Query() query: VenueCatalogQueryDto) {
    const result = await this.venueCatalogService.list(query);
    return {
      success: true,
      data: result.data,
      pagination: result.pagination,
    };
  }

  @Get('venues/catalog/:id')
  @ApiOperation({ summary: 'Get a venue catalog entry' })
  @ApiResponse({ status: 200, description: 'Catalog entry retrieved' })
  async getVenueCatalog(@Param('id') id: string) {
    const data = await this.venueCatalogService.findOne(id);
    return {
      success: true,
      data,
    };
  }

  @Post('venues/catalog')
  @ApiOperation({ summary: 'Create a venue catalog entry' })
  @ApiResponse({ status: 201, description: 'Catalog entry created' })
  async createVenueCatalog(@Body() dto: CreateVenueCatalogDto) {
    const data = await this.venueCatalogService.create(dto);
    return {
      success: true,
      data,
      message: 'Catalog entry created successfully',
    };
  }

  @Patch('venues/catalog/:id')
  @ApiOperation({ summary: 'Update a venue catalog entry' })
  @ApiResponse({ status: 200, description: 'Catalog entry updated' })
  async updateVenueCatalog(
    @Param('id') id: string,
    @Body() dto: UpdateVenueCatalogDto,
  ) {
    const data = await this.venueCatalogService.update(id, dto);
    return {
      success: true,
      data,
      message: 'Catalog entry updated successfully',
    };
  }

  @Delete('venues/catalog/:id')
  @ApiOperation({ summary: 'Delete (soft) a venue catalog entry' })
  @ApiResponse({ status: 200, description: 'Catalog entry deleted' })
  async deleteVenueCatalog(@Param('id') id: string) {
    const data = await this.venueCatalogService.delete(id);
    return {
      success: true,
      data,
      message: 'Catalog entry deleted successfully',
    };
  }

  @Post('venues/catalog/import')
  @UseInterceptors(
    FileInterceptor('file', {
      storage: multer.memoryStorage(),
    }),
  )
  @ApiOperation({ summary: 'Import venue catalog entries from JSON file' })
  @ApiResponse({
    status: 200,
    description: 'Catalog entries processed successfully',
  })
  async importVenueCatalog(
    @UploadedFile() file: multer.Multer.File,
    @Query() options: VenueCatalogImportOptionsDto,
  ) {
    if (!file) {
      throw new BadRequestException(
        'Upload a JSON file under the "file" field',
      );
    }
    const data = await this.venueCatalogService.importFromFile(
      file.buffer,
      options,
    );
    return {
      success: true,
      data,
      message: 'Catalog import processed',
    };
  }

  // Venue Management
  @Get('venues')
  @ApiOperation({ summary: 'List all venues' })
  @ApiResponse({ status: 200, description: 'Venues retrieved successfully' })
  async listVenues(@Query() query: AdminVenueQueryDto) {
    const result = await this.venuesAdminService.list(query);
    return {
      success: true,
      data: result.data,
      pagination: result.pagination,
    };
  }

  @Get('venues/:id')
  @ApiOperation({ summary: 'Get venue details' })
  @ApiResponse({ status: 200, description: 'Venue retrieved successfully' })
  async getVenue(@Param('id') id: string) {
    const data = await this.venuesAdminService.findOne(id);
    return {
      success: true,
      data,
    };
  }

  @Delete('venues/:id')
  @ApiOperation({ summary: 'Archive a venue' })
  @ApiResponse({ status: 200, description: 'Venue archived successfully' })
  async archiveVenue(@Param('id') id: string) {
    const data = await this.venuesAdminService.archive(id);
    return {
      success: true,
      data,
    };
  }

  @Post('venues/:id/restore')
  @ApiOperation({ summary: 'Restore an archived venue' })
  @ApiResponse({ status: 200, description: 'Venue restored successfully' })
  async restoreVenue(@Param('id') id: string) {
    const data = await this.venuesAdminService.restore(id);
    return {
      success: true,
      data,
    };
  }

  // Refund Management
  @Get('refunds')
  @ApiOperation({ summary: 'Get all refunds with pagination and filters' })
  @ApiResponse({ status: 200, description: 'Refunds retrieved successfully' })
  async getRefunds(@Query() query: RefundQueryDto) {
    const result = await this.refundService.getRefunds(query);
    return {
      success: true,
      data: result,
    };
  }

  @Get('refunds/:id')
  @ApiOperation({ summary: 'Get refund by ID' })
  @ApiResponse({ status: 200, description: 'Refund retrieved successfully' })
  @ApiResponse({ status: 404, description: 'Refund not found' })
  async getRefund(@Param('id') id: string) {
    const data = await this.refundService.getRefund(id);
    return {
      success: true,
      data,
    };
  }

  @Post('refunds')
  @ApiOperation({ summary: 'Create a refund' })
  @ApiResponse({ status: 201, description: 'Refund created successfully' })
  @ApiResponse({ status: 400, description: 'Invalid refund request' })
  async createRefund(@Body() dto: CreateRefundDto) {
    const data = await this.refundService.createRefund(dto);
    return {
      success: true,
      data,
      message: 'Refund created successfully',
    };
  }

  @Patch('refunds/:id/status')
  @ApiOperation({ summary: 'Update refund status' })
  @ApiResponse({
    status: 200,
    description: 'Refund status updated successfully',
  })
  @ApiResponse({ status: 404, description: 'Refund not found' })
  async updateRefundStatus(
    @Param('id') id: string,
    @Body() dto: UpdateRefundStatusDto,
  ) {
    const data = await this.refundService.updateRefundStatus(id, dto);
    return {
      success: true,
      data,
      message: 'Refund status updated successfully',
    };
  }

  @Post('refunds/:id/approve')
  @HttpCode(HttpStatus.OK)
  @ApiOperation({ summary: 'Approve refund' })
  @ApiResponse({ status: 200, description: 'Refund approved successfully' })
  @ApiResponse({ status: 404, description: 'Refund not found' })
  async approveRefund(@Param('id') id: string, @Body() dto: ApproveRefundDto) {
    const result = await this.refundService.approveRefund(id, dto);
    return {
      success: true,
      data: null,
      ...result,
    };
  }

  @Post('refunds/:id/reject')
  @HttpCode(HttpStatus.OK)
  @ApiOperation({ summary: 'Reject refund' })
  @ApiResponse({ status: 200, description: 'Refund rejected successfully' })
  @ApiResponse({ status: 404, description: 'Refund not found' })
  async rejectRefund(@Param('id') id: string, @Body() dto: RejectRefundDto) {
    const result = await this.refundService.rejectRefund(id, dto);
    return {
      success: true,
      data: null,
      ...result,
    };
  }

  @Post('refunds/:id/process')
  @HttpCode(HttpStatus.OK)
  @ApiOperation({ summary: 'Process refund with payment provider' })
  @ApiResponse({
    status: 200,
    description: 'Refund processed successfully',
  })
  @ApiResponse({ status: 404, description: 'Refund not found' })
  @ApiResponse({ status: 400, description: 'Refund cannot be processed' })
  async processRefund(@Param('id') id: string, @Body() dto: ProcessRefundDto) {
    const result = await this.refundService.processRefund(id, dto);
    return {
      success: true,
      data: null,
      ...result,
    };
  }

  // Organization Verification Management
  @Get('organizations/verification')
  @ApiOperation({
    summary: 'Get organizations for verification review',
  })
  @ApiResponse({
    status: 200,
    description: 'Organizations retrieved successfully',
  })
  async getOrganizationsForVerification(
    @Query() query: OrganizationVerificationQueryDto,
  ) {
    const result =
      await this.organizationService.getOrganizationsForVerification(query);
    return {
      success: true,
      data: result,
    };
  }

  @Get('organizations/:id/verification')
  @ApiOperation({ summary: 'Get organization verification details' })
  @ApiResponse({
    status: 200,
    description: 'Organization verification details retrieved successfully',
  })
  @ApiResponse({ status: 404, description: 'Organization not found' })
  async getOrganizationForVerification(@Param('id') id: string) {
    const data =
      await this.organizationService.getOrganizationForVerification(id);
    return {
      success: true,
      data,
    };
  }

  @Post('organizations/:id/verification/submit')
  @HttpCode(HttpStatus.OK)
  @ApiOperation({ summary: 'Submit organization for verification' })
  @ApiResponse({
    status: 200,
    description: 'Organization submitted for verification successfully',
  })
  async submitOrganizationForVerification(
    @Param('id') id: string,
    @Body() dto: SubmitForVerificationDto,
    @CurrentUser() user: { id?: string },
  ) {
    const result =
      await this.organizationService.submitOrganizationForVerification(
        id,
        dto,
        user?.id || '',
      );
    return {
      success: true,
      data: null,
      ...result,
    };
  }

  @Post('organizations/:id/verification/documents')
  @UseInterceptors(FileInterceptor('file'))
  @ApiOperation({ summary: 'Upload verification document' })
  @ApiResponse({
    status: 201,
    description: 'Document uploaded successfully',
  })
  async uploadVerificationDocument(
    @Param('id') id: string,
    @Body() dto: UploadDocumentDto,
    @UploadedFile() file: multer.Multer.File,
    @CurrentUser() user: { id?: string },
  ) {
    const result = await this.organizationService.uploadVerificationDocument(
      id,
      dto,
      file,
      user?.id || '',
    );
    return {
      success: true,
      data: result,
    };
  }

  @Post('organizations/verification/documents/:id/review')
  @HttpCode(HttpStatus.OK)
  @ApiOperation({ summary: 'Review verification document' })
  @ApiResponse({
    status: 200,
    description: 'Document reviewed successfully',
  })
  async reviewVerificationDocument(
    @Param('id') id: string,
    @Body() dto: ReviewDocumentDto,
    @CurrentUser() user: { id?: string },
  ) {
    const result = await this.organizationService.reviewVerificationDocument(
      id,
      dto,
      user?.id || '',
    );
    return {
      success: true,
      data: null,
      ...result,
    };
  }

  @Post('organizations/:id/verification/approve')
  @HttpCode(HttpStatus.OK)
  @ApiOperation({ summary: 'Approve organization verification' })
  @ApiResponse({
    status: 200,
    description: 'Organization approved successfully',
  })
  async approveOrganization(
    @Param('id') id: string,
    @Body() dto: ApproveOrganizationDto,
    @CurrentUser() user: { id?: string },
  ) {
    const result = await this.organizationService.approveOrganization(
      id,
      dto,
      user?.id || '',
    );
    return {
      success: true,
      data: null,
      ...result,
    };
  }

  @Post('organizations/:id/verification/reject')
  @HttpCode(HttpStatus.OK)
  @ApiOperation({ summary: 'Reject organization verification' })
  @ApiResponse({
    status: 200,
    description: 'Organization rejected',
  })
  async rejectOrganization(
    @Param('id') id: string,
    @Body() dto: RejectOrganizationDto,
    @CurrentUser() user: { id?: string },
  ) {
    const result = await this.organizationService.rejectOrganization(
      id,
      dto,
      user?.id || '',
    );
    return {
      success: true,
      data: null,
      ...result,
    };
  }

  @Post('organizations/:id/verification/suspend')
  @HttpCode(HttpStatus.OK)
  @ApiOperation({ summary: 'Suspend organization' })
  @ApiResponse({
    status: 200,
    description: 'Organization suspended',
  })
  async suspendOrganization(
    @Param('id') id: string,
    @Body() dto: SuspendOrganizationDto,
    @CurrentUser() user: { id?: string },
  ) {
    const result = await this.organizationService.suspendOrganization(
      id,
      dto,
      user?.id || '',
    );
    return {
      success: true,
      data: null,
      ...result,
    };
  }

  @Post('organizations/verification/appeals/:id/review')
  @HttpCode(HttpStatus.OK)
  @ApiOperation({ summary: 'Review organization appeal' })
  @ApiResponse({
    status: 200,
    description: 'Appeal reviewed successfully',
  })
  async reviewOrganizationAppeal(
    @Param('id') id: string,
    @Body() dto: AppealReviewDto,
    @CurrentUser() user: { id?: string },
  ) {
    const result = await this.organizationService.reviewOrganizationAppeal(
      id,
      dto,
      user?.id || '',
    );
    return {
      success: true,
      data: null,
      ...result,
    };
  }

  // Dispute Management
  @Get('disputes')
  @ApiOperation({ summary: 'Get all disputes with pagination and filters' })
  @ApiResponse({ status: 200, description: 'Disputes retrieved successfully' })
  async getDisputes(@Query() query: DisputeQueryDto) {
    const result = await this.disputeService.getDisputes(query);
    return {
      success: true,
      data: result,
    };
  }

  @Get('disputes/stats')
  @ApiOperation({ summary: 'Get dispute statistics' })
  @ApiResponse({ status: 200, description: 'Dispute stats retrieved successfully' })
  async getDisputeStats() {
    const stats = await this.disputeService.getDisputeStats();
    return {
      success: true,
      data: stats,
    };
  }

  @Get('disputes/:id')
  @ApiOperation({ summary: 'Get dispute details' })
  @ApiResponse({ status: 200, description: 'Dispute retrieved successfully' })
  async getDispute(@Param('id') id: string) {
    const dispute = await this.disputeService.getDispute(id);
    return {
      success: true,
      data: dispute,
    };
  }

  @Patch('disputes/:id/status')
  @ApiOperation({ summary: 'Update dispute status' })
  @ApiResponse({ status: 200, description: 'Dispute status updated successfully' })
  async updateDisputeStatus(
    @Param('id') id: string,
    @Body() dto: UpdateDisputeStatusDto,
  ) {
    const dispute = await this.disputeService.updateDisputeStatus(id, dto);
    return {
      success: true,
      data: dispute,
    };
  }

  @Post('disputes/:id/respond')
  @ApiOperation({ summary: 'Respond to dispute with payment provider' })
  @ApiResponse({ status: 200, description: 'Response submitted successfully' })
  async respondToDispute(
    @Param('id') id: string,
    @Body() dto: RespondToDisputeDto,
  ) {
    const result = await this.disputeService.respondToDispute(id, dto);
    return {
      success: true,
      data: result,
    };
  }

  @Post('disputes/:id/close')
  @ApiOperation({ summary: 'Close dispute' })
  @ApiResponse({ status: 200, description: 'Dispute closed successfully' })
  async closeDispute(
    @Param('id') id: string,
    @Body() dto: CloseDisputeDto,
  ) {
    const dispute = await this.disputeService.closeDispute(id, dto);
    return {
      success: true,
      data: dispute,
    };
  }

  // Fee Schedule Management
  @Get('fee-schedules')
  @ApiOperation({ summary: 'Get all fee schedules with pagination and filters' })
  @ApiResponse({ status: 200, description: 'Fee schedules retrieved successfully' })
  async getFeeSchedules(@Query() query: FeeScheduleQueryDto) {
    const result = await this.feeScheduleService.getFeeSchedules(query);
    return {
      success: true,
      data: result,
    };
  }

  @Get('fee-schedules/stats')
  @ApiOperation({ summary: 'Get fee schedule statistics' })
  @ApiResponse({ status: 200, description: 'Fee schedule stats retrieved successfully' })
  async getFeeScheduleStats() {
    const stats = await this.feeScheduleService.getFeeScheduleStats();
    return {
      success: true,
      data: stats,
    };
  }

  @Get('fee-schedules/:id')
  @ApiOperation({ summary: 'Get fee schedule details' })
  @ApiResponse({ status: 200, description: 'Fee schedule retrieved successfully' })
  async getFeeSchedule(@Param('id') id: string) {
    const feeSchedule = await this.feeScheduleService.getFeeSchedule(id);
    return {
      success: true,
      data: feeSchedule,
    };
  }

  @Post('fee-schedules')
  @ApiOperation({ summary: 'Create new fee schedule' })
  @ApiResponse({ status: 201, description: 'Fee schedule created successfully' })
  async createFeeSchedule(@Body() dto: CreateFeeScheduleDto) {
    const feeSchedule = await this.feeScheduleService.createFeeSchedule(dto);
    return {
      success: true,
      data: feeSchedule,
    };
  }

  @Patch('fee-schedules/:id')
  @ApiOperation({ summary: 'Update fee schedule' })
  @ApiResponse({ status: 200, description: 'Fee schedule updated successfully' })
  async updateFeeSchedule(
    @Param('id') id: string,
    @Body() dto: UpdateFeeScheduleDto,
  ) {
    const feeSchedule = await this.feeScheduleService.updateFeeSchedule(id, dto);
    return {
      success: true,
      data: feeSchedule,
    };
  }

  @Delete('fee-schedules/:id')
  @ApiOperation({ summary: 'Delete fee schedule' })
  @ApiResponse({ status: 200, description: 'Fee schedule deleted successfully' })
  @HttpCode(HttpStatus.OK)
  async deleteFeeSchedule(@Param('id') id: string) {
    const result = await this.feeScheduleService.deleteFeeSchedule(id);
    return {
      success: true,
      ...result,
    };
  }

  @Post('fee-schedules/:id/deactivate')
  @ApiOperation({ summary: 'Deactivate fee schedule' })
  @ApiResponse({ status: 200, description: 'Fee schedule deactivated successfully' })
  async deactivateFeeSchedule(@Param('id') id: string) {
    const result = await this.feeScheduleService.deactivateFeeSchedule(id);
    return {
      success: true,
      ...result,
    };
  }

  // Organization Fee Override Management
  @Post('fee-schedules/overrides')
  @ApiOperation({ summary: 'Create organization fee override' })
  @ApiResponse({ status: 201, description: 'Fee override created successfully' })
  async createOrgFeeOverride(@Body() dto: CreateOrgFeeOverrideDto) {
    const override = await this.feeScheduleService.createOrgFeeOverride(dto);
    return {
      success: true,
      data: override,
    };
  }

  @Get('fee-schedules/overrides/organization/:orgId')
  @ApiOperation({ summary: 'Get organization fee overrides' })
  @ApiResponse({ status: 200, description: 'Fee overrides retrieved successfully' })
  async getOrgFeeOverrides(@Param('orgId') orgId: string) {
    const overrides = await this.feeScheduleService.getOrgFeeOverrides(orgId);
    return {
      success: true,
      data: overrides,
    };
  }

  @Patch('fee-schedules/overrides/:id')
  @ApiOperation({ summary: 'Update organization fee override' })
  @ApiResponse({ status: 200, description: 'Fee override updated successfully' })
  async updateOrgFeeOverride(
    @Param('id') id: string,
    @Body() dto: UpdateOrgFeeOverrideDto,
  ) {
    const override = await this.feeScheduleService.updateOrgFeeOverride(id, dto);
    return {
      success: true,
      data: override,
    };
  }

  @Delete('fee-schedules/overrides/:id')
  @ApiOperation({ summary: 'Delete organization fee override' })
  @ApiResponse({ status: 200, description: 'Fee override deleted successfully' })
  @HttpCode(HttpStatus.OK)
  async deleteOrgFeeOverride(@Param('id') id: string) {
    const result = await this.feeScheduleService.deleteOrgFeeOverride(id);
    return {
      success: true,
      ...result,
    };
  }

  // Tax Rate Management
  @Get('tax-rates')
  @ApiOperation({ summary: 'Get all tax rates with pagination and filters' })
  @ApiResponse({ status: 200, description: 'Tax rates retrieved successfully' })
  async getTaxRates(@Query() query: TaxRateQueryDto) {
    const result = await this.taxRateService.getTaxRates(query);
    return {
      success: true,
      data: result,
    };
  }

  @Get('tax-rates/stats')
  @ApiOperation({ summary: 'Get tax rate statistics' })
  @ApiResponse({ status: 200, description: 'Tax rate stats retrieved successfully' })
  async getTaxRateStats() {
    const stats = await this.taxRateService.getTaxRateStats();
    return {
      success: true,
      data: stats,
    };
  }

  @Get('tax-rates/country/:country')
  @ApiOperation({ summary: 'Get tax rates by country' })
  @ApiResponse({ status: 200, description: 'Tax rates retrieved successfully' })
  async getTaxRatesByCountry(@Param('country') country: string) {
    const taxRates = await this.taxRateService.getTaxRatesByCountry(country);
    return {
      success: true,
      data: taxRates,
    };
  }

  @Get('tax-rates/:id')
  @ApiOperation({ summary: 'Get tax rate details' })
  @ApiResponse({ status: 200, description: 'Tax rate retrieved successfully' })
  async getTaxRate(@Param('id') id: string) {
    const taxRate = await this.taxRateService.getTaxRate(id);
    return {
      success: true,
      data: taxRate,
    };
  }

  @Post('tax-rates')
  @ApiOperation({ summary: 'Create new tax rate' })
  @ApiResponse({ status: 201, description: 'Tax rate created successfully' })
  async createTaxRate(@Body() dto: CreateTaxRateDto) {
    const taxRate = await this.taxRateService.createTaxRate(dto);
    return {
      success: true,
      data: taxRate,
    };
  }

  @Patch('tax-rates/:id')
  @ApiOperation({ summary: 'Update tax rate' })
  @ApiResponse({ status: 200, description: 'Tax rate updated successfully' })
  async updateTaxRate(
    @Param('id') id: string,
    @Body() dto: UpdateTaxRateDto,
  ) {
    const taxRate = await this.taxRateService.updateTaxRate(id, dto);
    return {
      success: true,
      data: taxRate,
    };
  }

  @Delete('tax-rates/:id')
  @ApiOperation({ summary: 'Delete tax rate' })
  @ApiResponse({ status: 200, description: 'Tax rate deleted successfully' })
  @HttpCode(HttpStatus.OK)
  async deleteTaxRate(@Param('id') id: string) {
    const result = await this.taxRateService.deleteTaxRate(id);
    return {
      success: true,
      ...result,
    };
  }

  @Post('tax-rates/:id/deactivate')
  @ApiOperation({ summary: 'Deactivate tax rate' })
  @ApiResponse({ status: 200, description: 'Tax rate deactivated successfully' })
  async deactivateTaxRate(@Param('id') id: string) {
    const result = await this.taxRateService.deactivateTaxRate(id);
    return {
      success: true,
      ...result,
    };
  }

  // Session Management
  @Get('sessions')
  @ApiOperation({ summary: 'Get all sessions with pagination and filters' })
  @ApiResponse({ status: 200, description: 'Sessions retrieved successfully' })
  async getSessions(@Query() query: SessionQueryDto) {
    const result = await this.sessionService.getSessions(query);
    return {
      success: true,
      data: result,
    };
  }

  @Get('sessions/stats')
  @ApiOperation({ summary: 'Get session statistics' })
  @ApiResponse({ status: 200, description: 'Session stats retrieved successfully' })
  async getSessionStats() {
    const stats = await this.sessionService.getSessionStats();
    return {
      success: true,
      data: stats,
    };
  }

  @Delete('sessions/:id')
  @ApiOperation({ summary: 'Revoke session' })
  @ApiResponse({ status: 200, description: 'Session revoked successfully' })
  @HttpCode(HttpStatus.OK)
  async revokeSession(@Param('id') id: string) {
    const result = await this.sessionService.revokeSession(id);
    return {
      success: true,
      ...result,
    };
  }

  @Post('sessions/users/:userId/revoke-all')
  @ApiOperation({ summary: 'Revoke all user sessions' })
  @ApiResponse({ status: 200, description: 'All sessions revoked successfully' })
  @HttpCode(HttpStatus.OK)
  async revokeAllUserSessions(@Param('userId') userId: string) {
    const result = await this.sessionService.revokeAllUserSessions(userId);
    return {
      success: true,
      ...result,
    };
  }

  // Webhook Management
  @Get('webhooks')
  @ApiOperation({ summary: 'Get all webhooks with pagination and filters' })
  @ApiResponse({ status: 200, description: 'Webhooks retrieved successfully' })
  async getWebhooks(@Query() query: WebhookQueryDto) {
    const result = await this.webhookService.getWebhooks(query);
    return {
      success: true,
      data: result,
    };
  }

  @Get('webhooks/stats')
  @ApiOperation({ summary: 'Get webhook statistics' })
  @ApiResponse({ status: 200, description: 'Webhook stats retrieved successfully' })
  async getWebhookStats() {
    const stats = await this.webhookService.getWebhookStats();
    return {
      success: true,
      data: stats,
    };
  }

  @Get('webhooks/:id')
  @ApiOperation({ summary: 'Get webhook details' })
  @ApiResponse({ status: 200, description: 'Webhook retrieved successfully' })
  async getWebhook(@Param('id') id: string) {
    const webhook = await this.webhookService.getWebhook(id);
    return {
      success: true,
      data: webhook,
    };
  }

  @Get('webhook-events')
  @ApiOperation({ summary: 'Get webhook events/deliveries' })
  @ApiResponse({ status: 200, description: 'Webhook events retrieved successfully' })
  async getWebhookEvents(@Query() query: WebhookEventQueryDto) {
    const result = await this.webhookService.getWebhookEvents(query);
    return {
      success: true,
      data: result,
    };
  }

  @Post('webhook-events/:id/retry')
  @ApiOperation({ summary: 'Retry failed webhook event' })
  @ApiResponse({ status: 200, description: 'Webhook retry queued successfully' })
  @HttpCode(HttpStatus.OK)
  async retryWebhookEvent(@Param('id') id: string) {
    const result = await this.webhookService.retryWebhookEvent(id);
    return {
      success: true,
      ...result,
    };
  }

  @Post('webhooks/:id/test')
  @ApiOperation({ summary: 'Test webhook endpoint' })
  @ApiResponse({ status: 200, description: 'Test webhook sent successfully' })
  @HttpCode(HttpStatus.OK)
  async testWebhook(@Param('id') id: string) {
    const result = await this.webhookService.testWebhook(id);
    return {
      success: true,
      ...result,
    };
  }

  // Revenue Analytics
  @Get('revenue/overview')
  @ApiOperation({ summary: 'Get revenue overview' })
  @ApiResponse({ status: 200, description: 'Revenue overview retrieved successfully' })
  async getRevenueOverview(@Query() query: RevenueQueryDto) {
    const data = await this.revenueService.getRevenueOverview(query);
    return {
      success: true,
      data,
    };
  }

  @Get('revenue/by-period')
  @ApiOperation({ summary: 'Get revenue by time period' })
  @ApiResponse({ status: 200, description: 'Revenue by period retrieved successfully' })
  async getRevenueByPeriod(@Query() query: RevenueQueryDto) {
    const data = await this.revenueService.getRevenueByPeriod(query);
    return {
      success: true,
      data,
    };
  }

  @Get('revenue/by-organization')
  @ApiOperation({ summary: 'Get revenue by organization' })
  @ApiResponse({ status: 200, description: 'Revenue by organization retrieved successfully' })
  async getRevenueByOrganization(@Query() query: RevenueQueryDto) {
    const data = await this.revenueService.getRevenueByOrganization(query);
    return {
      success: true,
      data,
    };
  }

  @Get('revenue/by-category')
  @ApiOperation({ summary: 'Get revenue by event category' })
  @ApiResponse({ status: 200, description: 'Revenue by category retrieved successfully' })
  async getRevenueByCategory(@Query() query: RevenueQueryDto) {
    const data = await this.revenueService.getRevenueByCategory(query);
    return {
      success: true,
      data,
    };
  }

  @Get('revenue/trends')
  @ApiOperation({ summary: 'Get revenue trends' })
  @ApiResponse({ status: 200, description: 'Revenue trends retrieved successfully' })
  async getRevenueTrends(@Query() query: RevenueQueryDto) {
    const data = await this.revenueService.getRevenueTrends(query);
    return {
      success: true,
      data,
    };
  }

  // Moderation & Flags
  @Get('flags')
  @ApiOperation({ summary: 'Get all flags with pagination and filters' })
  @ApiResponse({ status: 200, description: 'Flags retrieved successfully' })
  async getFlags(@Query() query: FlagQueryDto) {
    const result = await this.moderationService.getFlags(query);
    return {
      success: true,
      data: result,
    };
  }

  @Get('flags/stats')
  @ApiOperation({ summary: 'Get moderation statistics' })
  @ApiResponse({ status: 200, description: 'Moderation stats retrieved successfully' })
  async getModerationStats() {
    const stats = await this.moderationService.getModerationStats();
    return {
      success: true,
      data: stats,
    };
  }

  @Get('flags/:id')
  @ApiOperation({ summary: 'Get flag details' })
  @ApiResponse({ status: 200, description: 'Flag retrieved successfully' })
  async getFlag(@Param('id') id: string) {
    const flag = await this.moderationService.getFlag(id);
    return {
      success: true,
      data: flag,
    };
  }

  @Post('flags/:id/resolve')
  @ApiOperation({ summary: 'Resolve flag' })
  @ApiResponse({ status: 200, description: 'Flag resolved successfully' })
  @HttpCode(HttpStatus.OK)
  async resolveFlag(
    @Param('id') id: string,
    @Body() dto: ResolveFlagDto,
    @CurrentUser() user: { id?: string },
  ) {
    const result = await this.moderationService.resolveFlag(id, dto, user?.id || '');
    return {
      success: true,
      ...result,
    };
  }

  @Get('moderation/actions')
  @ApiOperation({ summary: 'Get moderation actions' })
  @ApiResponse({ status: 200, description: 'Moderation actions retrieved successfully' })
  async getModerationActions(@Query() query: ModerationActionQueryDto) {
    const result = await this.moderationService.getModerationActions(query);
    return {
      success: true,
      data: result,
    };
  }

  // Notifications
  @Get('notifications')
  @ApiOperation({ summary: 'Get all notifications with pagination and filters' })
  @ApiResponse({ status: 200, description: 'Notifications retrieved successfully' })
  async getNotifications(@Query() query: NotificationQueryDto) {
    const result = await this.notificationService.getNotifications(query);
    return {
      success: true,
      data: result,
    };
  }

  @Get('notifications/stats')
  @ApiOperation({ summary: 'Get notification statistics' })
  @ApiResponse({ status: 200, description: 'Notification stats retrieved successfully' })
  async getNotificationStats() {
    const stats = await this.notificationService.getNotificationStats();
    return {
      success: true,
      data: stats,
    };
  }

  @Post('notifications/broadcast')
  @ApiOperation({ summary: 'Broadcast notification to users' })
  @ApiResponse({ status: 200, description: 'Broadcast notification sent successfully' })
  async broadcastNotification(@Body() dto: BroadcastNotificationDto) {
    const result = await this.notificationService.broadcastNotification(dto);
    return {
      success: true,
      ...result,
    };
  }

  @Delete('notifications/:id')
  @ApiOperation({ summary: 'Delete notification' })
  @ApiResponse({ status: 200, description: 'Notification deleted successfully' })
  @HttpCode(HttpStatus.OK)
  async deleteNotification(@Param('id') id: string) {
    const result = await this.notificationService.deleteNotification(id);
    return {
      success: true,
      ...result,
    };
  }

  // Reviews
  @Get('reviews/events')
  @ApiOperation({ summary: 'Get event reviews' })
  @ApiResponse({ status: 200, description: 'Event reviews retrieved successfully' })
  async getEventReviews(@Query() query: ReviewQueryDto) {
    const result = await this.reviewService.getEventReviews(query);
    return {
      success: true,
      data: result,
    };
  }

  @Get('reviews/organizers')
  @ApiOperation({ summary: 'Get organizer reviews' })
  @ApiResponse({ status: 200, description: 'Organizer reviews retrieved successfully' })
  async getOrganizerReviews(@Query() query: ReviewQueryDto) {
    const result = await this.reviewService.getOrganizerReviews(query);
    return {
      success: true,
      data: result,
    };
  }

  @Get('reviews/stats')
  @ApiOperation({ summary: 'Get review statistics' })
  @ApiResponse({ status: 200, description: 'Review stats retrieved successfully' })
  async getReviewStats() {
    const stats = await this.reviewService.getReviewStats();
    return {
      success: true,
      data: stats,
    };
  }

  @Delete('reviews/events/:id')
  @ApiOperation({ summary: 'Delete event review' })
  @ApiResponse({ status: 200, description: 'Event review deleted successfully' })
  @HttpCode(HttpStatus.OK)
  async deleteEventReview(@Param('id') id: string) {
    const result = await this.reviewService.deleteEventReview(id);
    return {
      success: true,
      ...result,
    };
  }

  @Delete('reviews/organizers/:id')
  @ApiOperation({ summary: 'Delete organizer review' })
  @ApiResponse({ status: 200, description: 'Organizer review deleted successfully' })
  @HttpCode(HttpStatus.OK)
  async deleteOrganizerReview(@Param('id') id: string) {
    const result = await this.reviewService.deleteOrganizerReview(id);
    return {
      success: true,
      ...result,
    };
  }

  // Orders
  @Get('orders')
  @ApiOperation({ summary: 'Get all orders with pagination and filters' })
  @ApiResponse({ status: 200, description: 'Orders retrieved successfully' })
  async getOrders(@Query() query: OrderAdminQueryDto) {
    const result = await this.orderService.getOrders(query);
    return {
      success: true,
      data: result,
    };
  }

  @Get('orders/stats')
  @ApiOperation({ summary: 'Get order statistics' })
  @ApiResponse({ status: 200, description: 'Order stats retrieved successfully' })
  async getOrderStats() {
    const stats = await this.orderService.getOrderStats();
    return {
      success: true,
      data: stats,
    };
  }

  @Get('orders/:id')
  @ApiOperation({ summary: 'Get order details' })
  @ApiResponse({ status: 200, description: 'Order retrieved successfully' })
  async getOrder(@Param('id') id: string) {
    const order = await this.orderService.getOrder(id);
    return {
      success: true,
      data: order,
    };
  }

  @Patch('orders/:id/status')
  @ApiOperation({ summary: 'Update order status' })
  @ApiResponse({ status: 200, description: 'Order status updated successfully' })
  async updateOrderStatus(
    @Param('id') id: string,
    @Body() dto: UpdateOrderStatusDto,
  ) {
    const result = await this.orderService.updateOrderStatus(id, dto);
    return {
      success: true,
      ...result,
    };
  }

  @Post('orders/:id/cancel')
  @ApiOperation({ summary: 'Cancel order' })
  @ApiResponse({ status: 200, description: 'Order canceled successfully' })
  @HttpCode(HttpStatus.OK)
  async cancelOrder(@Param('id') id: string) {
    const result = await this.orderService.cancelOrder(id);
    return {
      success: true,
      ...result,
    };
  }

  // Tickets
  @Get('tickets')
  @ApiOperation({ summary: 'Get all tickets with pagination and filters' })
  @ApiResponse({ status: 200, description: 'Tickets retrieved successfully' })
  async getTickets(@Query() query: TicketAdminQueryDto) {
    const result = await this.ticketService.getTickets(query);
    return {
      success: true,
      data: result,
    };
  }

  @Get('tickets/stats')
  @ApiOperation({ summary: 'Get ticket statistics' })
  @ApiResponse({ status: 200, description: 'Ticket stats retrieved successfully' })
  async getTicketStats() {
    const stats = await this.ticketService.getTicketStats();
    return {
      success: true,
      data: stats,
    };
  }

  @Get('tickets/:id')
  @ApiOperation({ summary: 'Get ticket details' })
  @ApiResponse({ status: 200, description: 'Ticket retrieved successfully' })
  async getTicket(@Param('id') id: string) {
    const ticket = await this.ticketService.getTicket(id);
    return {
      success: true,
      data: ticket,
    };
  }

  @Post('tickets/:id/void')
  @ApiOperation({ summary: 'Void ticket' })
  @ApiResponse({ status: 200, description: 'Ticket voided successfully' })
  @HttpCode(HttpStatus.OK)
  async voidTicket(@Param('id') id: string) {
    const result = await this.ticketService.voidTicket(id);
    return {
      success: true,
      ...result,
    };
  }

  @Get('tickets/transfers')
  @ApiOperation({ summary: 'Get ticket transfers' })
  @ApiResponse({ status: 200, description: 'Transfers retrieved successfully' })
  async getTransfers(@Query() query: TransferQueryDto) {
    const result = await this.ticketService.getTransfers(query);
    return {
      success: true,
      data: result,
    };
  }

  @Get('tickets/checkins')
  @ApiOperation({ summary: 'Get ticket check-ins' })
  @ApiResponse({ status: 200, description: 'Check-ins retrieved successfully' })
  async getCheckins(@Query() query: CheckinQueryDto) {
    const result = await this.ticketService.getCheckins(query);
    return {
      success: true,
      data: result,
    };
  }

  // Promotions
  @Get('promotions')
  @ApiOperation({ summary: 'Get all promotions with pagination and filters' })
  @ApiResponse({ status: 200, description: 'Promotions retrieved successfully' })
  async getPromotions(@Query() query: PromotionQueryDto) {
    const result = await this.promotionService.getPromotions(query);
    return {
      success: true,
      data: result,
    };
  }

  @Get('promotions/stats')
  @ApiOperation({ summary: 'Get promotion statistics' })
  @ApiResponse({ status: 200, description: 'Promotion stats retrieved successfully' })
  async getPromotionStats() {
    const stats = await this.promotionService.getPromotionStats();
    return {
      success: true,
      data: stats,
    };
  }

  @Get('promotions/:id')
  @ApiOperation({ summary: 'Get promotion details' })
  @ApiResponse({ status: 200, description: 'Promotion retrieved successfully' })
  async getPromotion(@Param('id') id: string) {
    const promotion = await this.promotionService.getPromotion(id);
    return {
      success: true,
      data: promotion,
    };
  }

  @Post('promotions/:id/deactivate')
  @ApiOperation({ summary: 'Deactivate promotion' })
  @ApiResponse({ status: 200, description: 'Promotion deactivated successfully' })
  @HttpCode(HttpStatus.OK)
  async deactivatePromotion(@Param('id') id: string) {
    const result = await this.promotionService.deactivatePromotion(id);
    return {
      success: true,
      ...result,
    };
  }

  @Get('promo-codes')
  @ApiOperation({ summary: 'Get all promo codes with pagination and filters' })
  @ApiResponse({ status: 200, description: 'Promo codes retrieved successfully' })
  async getPromoCodes(@Query() query: PromoCodeQueryDto) {
    const result = await this.promotionService.getPromoCodes(query);
    return {
      success: true,
      data: result,
    };
  }
}
