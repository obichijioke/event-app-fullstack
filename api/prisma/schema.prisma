generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ---------- Enumerations ----------
enum PlatformRole {
  attendee
  organizer
  moderator
  admin
}

enum OrgMemberRole {
  owner
  manager
  finance
  staff
}

enum EventStatus {
  draft
  pending
  approved
  live
  paused
  ended
  canceled
}

enum Visibility {
  public
  unlisted
  private
}

enum VenueVisibility {
  shared_ref
  private
}

enum TicketKind {
  GA
  SEATED
}

enum OrderStatus {
  pending
  paid
  canceled
  refunded
  chargeback
}

enum TicketStatus {
  issued
  transferred
  refunded
  checked_in
  void
}

enum HoldReason {
  checkout
  reservation
  organizer_hold
}

enum PayoutStatus {
  pending
  in_review
  paid
  failed
  canceled
}

enum RefundStatus {
  pending
  approved
  processed
  failed
  canceled
}

enum PaymentStatus {
  requires_action
  authorized
  captured
  voided
  failed
}

enum ModerationStatus {
  open
  needs_changes
  approved
  rejected
  resolved
}

enum OrganizationType {
  business
  personal
  nonprofit
  government
}

enum OrganizationStatus {
  pending
  submitted
  under_review
  approved
  rejected
  suspended
  banned
}

enum VerificationDocumentType {
  business_license
  tax_id
  bank_statement
  identity_proof
  address_proof
  incorporation_docs
  other
}

enum VerificationStatus {
  pending
  approved
  rejected
  expired
}

// ---------- Identity & Access ----------
model User {
  id              String       @id @default(cuid())
  email           String       @unique
  emailVerifiedAt DateTime?
  passwordHash    String?      @map("password_hash")
  name            String?
  phone           String?
  role            PlatformRole @default(attendee)
  twofaEnabled    Boolean      @default(false) @map("twofa_enabled")
  status          String       @default("active")
  createdAt       DateTime     @default(now()) @map("created_at")
  updatedAt       DateTime     @updatedAt @map("updated_at")
  deletedAt       DateTime?    @map("deleted_at")

  // Relations
  sessions                        UserSession[]
  apiKeys                         ApiKey[]
  ownedOrgs                       Organization[]                  @relation("OrganizationOwner")
  orgMemberships                  OrgMember[]
  orders                          Order[]
  tickets                         Ticket[]
  transfersSent                   Transfer[]                      @relation("TransferFrom")
  transfersReceived               Transfer[]                      @relation("TransferTo")
  promoRedemptions                PromoRedemption[]
  refunds                         Refund[]
  flags                           Flag[]
  moderationActions               ModerationAction[]
  auditLogs                       AuditLog[]                      @relation("AuditLogActor")
  notifications                   Notification[]
  notificationPreferences         NotificationPreference[]        @relation("NotificationPreferences")
  holds                           Hold[]
  following                       UserFollow[]
  eventReviews                    EventReview[]
  organizerReviews                OrganizerReview[]
  reviewedDocuments               VerificationDocument[]
  reviewedAppeals                 OrganizationAppeal[]
  eventCreatorDraftsOwned         EventCreatorDraft[]             @relation("EventCreatorDraftOwner")
  eventCreatorDraftVersions       EventCreatorDraftVersion[]      @relation("EventCreatorDraftVersionAuthor")
  eventCreatorTemplates           EventCreatorTemplate[]          @relation("EventCreatorTemplateAuthor")
  eventCreatorDraftCollaborations EventCreatorDraftCollaborator[] @relation("EventCreatorDraftCollaboratorUser")
  EventCreatorTemplateAccess      EventCreatorTemplateAccess[]
  currencyConfigUpdates           CurrencyConfiguration[]
  currencyChangeLogs              CurrencyChangeLog[]

  @@map("users")
}

model UserSession {
  id        String    @id @default(cuid())
  userId    String    @map("user_id")
  userAgent String?   @map("user_agent")
  ipAddr    String?   @map("ip_addr")
  createdAt DateTime  @default(now()) @map("created_at")
  expiresAt DateTime  @map("expires_at")
  revokedAt DateTime? @map("revoked_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
  @@map("user_sessions")
}

model ApiKey {
  id           String    @id @default(cuid())
  userId       String    @map("user_id")
  name         String
  prefix       String
  hashedSecret String    @map("hashed_secret")
  scopes       String[]  @default([])
  createdAt    DateTime  @default(now()) @map("created_at")
  lastUsedAt   DateTime? @map("last_used_at")
  revokedAt    DateTime? @map("revoked_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([prefix])
  @@map("api_keys")
}

// ---------- Organizations & Payouts ----------
model Organization {
  id                String             @id @default(cuid())
  ownerId           String             @map("owner_id")
  name              String
  type              OrganizationType   @default(personal)
  legalName         String?            @map("legal_name")
  website           String?
  country           String?
  supportEmail      String?            @map("support_email")
  taxId             String?            @map("tax_id")
  status            OrganizationStatus @default(pending)
  payoutProvider    String?            @map("payout_provider")
  payoutAccountId   String?            @map("payout_account_id")
  trustScore        Decimal?           @default(0) @map("trust_score")
  verifiedAt        DateTime?          @map("verified_at")
  verificationNotes String?            @map("verification_notes")
  createdAt         DateTime           @default(now()) @map("created_at")
  updatedAt         DateTime           @updatedAt @map("updated_at")

  // Relations
  owner                 User                   @relation("OrganizationOwner", fields: [ownerId], references: [id])
  members               OrgMember[]
  venues                Venue[]
  events                Event[]
  promotions            Promotion[]
  promoCodes            PromoCode[]
  payoutAccounts        PayoutAccount[]
  payouts               Payout[]
  webhookEndpoints      WebhookEndpoint[]
  orgFeeOverrides       OrgFeeOverride[]
  orders                Order[]
  followers             UserFollow[]
  reviews               OrganizerReview[]
  verificationDocuments VerificationDocument[]
  appeals               OrganizationAppeal[]
  eventCreatorDrafts    EventCreatorDraft[]
  eventCreatorTemplates EventCreatorTemplate[]

  @@map("organizations")
}

// ---------- Organization Verification ----------
model VerificationDocument {
  id              String                   @id @default(cuid())
  orgId           String                   @map("org_id")
  type            VerificationDocumentType
  filename        String
  originalName    String                   @map("original_name")
  mimeType        String                   @map("mime_type")
  fileSize        Int                      @map("file_size")
  storageKey      String                   @map("storage_key") // S3 key or local path
  status          VerificationStatus       @default(pending)
  rejectionReason String?                  @map("rejection_reason")
  uploadedAt      DateTime                 @default(now()) @map("uploaded_at")
  reviewedAt      DateTime?                @map("reviewed_at")
  reviewedBy      String?                  @map("reviewed_by")

  // Relations
  org      Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  reviewer User?        @relation(fields: [reviewedBy], references: [id])

  @@index([orgId])
  @@index([status])
  @@map("verification_documents")
}

model OrganizationAppeal {
  id          String    @id @default(cuid())
  orgId       String    @map("org_id")
  reason      String
  details     String?
  status      String    @default("pending") // pending, approved, rejected
  submittedAt DateTime  @default(now()) @map("submitted_at")
  reviewedAt  DateTime? @map("reviewed_at")
  reviewedBy  String?   @map("reviewed_by")
  reviewNotes String?   @map("review_notes")

  // Relations
  org      Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  reviewer User?        @relation(fields: [reviewedBy], references: [id])

  @@index([orgId])
  @@index([status])
  @@map("organization_appeals")
}

model OrgMember {
  orgId     String        @map("org_id")
  userId    String        @map("user_id")
  role      OrgMemberRole
  invitedBy String?       @map("invited_by")
  createdAt DateTime      @default(now()) @map("created_at")

  // Relations
  org  Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  user User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([orgId, userId])
  @@index([userId])
  @@map("org_members")
}

model UserFollow {
  id             String   @id @default(cuid())
  userId         String   @map("user_id")
  organizationId String   @map("organization_id")
  createdAt      DateTime @default(now()) @map("created_at")

  // Relations
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([userId, organizationId])
  @@index([userId])
  @@index([organizationId])
  @@map("user_follows")
}

model PayoutAccount {
  id             String   @id @default(cuid())
  orgId          String   @map("org_id")
  provider       String
  externalId     String   @map("external_id")
  defaultAccount Boolean  @default(true) @map("default_account")
  createdAt      DateTime @default(now()) @map("created_at")

  // Relations
  org Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@unique([orgId, provider, externalId])
  @@map("payout_accounts")
}

model Payout {
  id            String       @id @default(cuid())
  orgId         String       @map("org_id")
  amountCents   BigInt       @map("amount_cents")
  currency      String
  status        PayoutStatus @default(pending)
  scheduledFor  DateTime?    @map("scheduled_for")
  initiatedAt   DateTime?
  provider      String?
  providerRef   String?      @map("provider_ref")
  failureReason String?      @map("failure_reason")
  createdAt     DateTime     @default(now()) @map("created_at")

  // Relations
  org Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@index([orgId, status])
  @@map("payouts")
}

// ---------- Venues & Seatmaps ----------
model VenueCatalog {
  id                 String    @id @default(cuid())
  slug               String?   @unique
  name               String
  description        String?
  imageUrl           String?   @map("image_url")
  address            Json
  timezone           String
  capacityMin        Int?      @map("capacity_min")
  capacityMax        Int?      @map("capacity_max")
  latitude           Decimal?  @db.Decimal(10, 8)
  longitude          Decimal?  @db.Decimal(11, 8)
  tags               String[]  @default([])
  defaultSeatmapSpec Json?     @map("default_seatmap_spec")
  createdAt          DateTime  @default(now()) @map("created_at")
  updatedAt          DateTime  @updatedAt @map("updated_at")
  deletedAt          DateTime? @map("deleted_at")

  // Relations
  venues Venue[]

  @@map("venue_catalogs")
}

model Venue {
  id             String          @id @default(cuid())
  orgId          String          @map("org_id")
  catalogVenueId String?         @map("catalog_venue_id")
  name           String
  address        Json // {line1, line2, city, region, postal, country}
  timezone       String
  capacity       Int?
  latitude       Decimal?        @db.Decimal(10, 8)
  longitude      Decimal?        @db.Decimal(11, 8)
  visibility     VenueVisibility @default(private)
  createdAt      DateTime        @default(now()) @map("created_at")
  deletedAt      DateTime?       @map("deleted_at")

  // Relations
  org          Organization  @relation(fields: [orgId], references: [id], onDelete: Cascade)
  catalogVenue VenueCatalog? @relation(fields: [catalogVenueId], references: [id], onDelete: SetNull)
  events       Event[]
  seatmaps     Seatmap[]

  @@index([orgId])
  @@index([catalogVenueId])
  @@index([latitude, longitude])
  @@map("venues")
}

model Seatmap {
  id          String   @id @default(cuid())
  venueId     String   @map("venue_id")
  name        String
  description String?
  spec        Json // full map for rendering
  isDefault   Boolean  @default(false) @map("is_default")
  createdAt   DateTime @default(now()) @map("created_at")

  // Relations
  venue         Venue          @relation(fields: [venueId], references: [id], onDelete: Cascade)
  seats         Seat[]
  events        Event[]
  eventSeatmaps EventSeatmap[]

  @@index([venueId])
  @@map("seatmaps")
}

model Seat {
  id        String  @id @default(cuid())
  seatmapId String  @map("seatmap_id")
  section   String?
  row       String?
  number    String?
  pos       Json? // {x,y,w,h}

  // Relations
  seatmap         Seatmap          @relation(fields: [seatmapId], references: [id], onDelete: Cascade)
  ticketTypeSeats TicketTypeSeat[]
  holds           Hold[]
  orderItems      OrderItem[]
  tickets         Ticket[]

  @@unique([seatmapId, section, row, number])
  @@index([seatmapId])
  @@map("seats")
}

model EventSeatmap {
  id        String   @id @default(cuid())
  eventId   String   @map("event_id")
  seatmapId String   @map("seatmap_id")
  snapshot  Json // frozen spec + seats at time of assignment
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  event   Event   @relation(fields: [eventId], references: [id], onDelete: Cascade)
  seatmap Seatmap @relation(fields: [seatmapId], references: [id], onDelete: Restrict)

  @@unique([eventId])
  @@map("event_seatmaps")
}

// ---------- Events ----------
model Category {
  id       String  @id @default(cuid())
  slug     String  @unique
  name     String
  parentId String? @map("parent_id")

  // Relations
  parent   Category?  @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children Category[] @relation("CategoryHierarchy")
  events   Event[]

  @@map("categories")
}

model Event {
  id             String      @id @default(cuid())
  orgId          String      @map("org_id")
  venueId        String?     @map("venue_id")
  seatmapId      String?     @map("seatmap_id")
  title          String
  descriptionMd  String?     @map("description_md")
  status         EventStatus @default(draft)
  visibility     Visibility  @default(public)
  categoryId     String?     @map("category_id")
  startAt        DateTime    @map("start_at")
  endAt          DateTime    @map("end_at")
  doorTime       DateTime?   @map("door_time")
  publishAt      DateTime?   @map("publish_at")
  ageRestriction String?     @map("age_restriction")
  coverImageUrl  String?     @map("cover_image_url")
  language       String?
  tags           String[]    @default([])
  latitude       Decimal?    @db.Decimal(10, 8)
  longitude      Decimal?    @db.Decimal(11, 8)
  createdAt      DateTime    @default(now()) @map("created_at")
  updatedAt      DateTime    @updatedAt @map("updated_at")
  deletedAt      DateTime?   @map("deleted_at")

  // Relations
  org                Organization        @relation(fields: [orgId], references: [id], onDelete: Cascade)
  venue              Venue?              @relation(fields: [venueId], references: [id], onDelete: SetNull)
  seatmap            Seatmap?            @relation(fields: [seatmapId], references: [id], onDelete: SetNull)
  category           Category?           @relation(fields: [categoryId], references: [id])
  occurrences        EventOccurrence[]
  assets             EventAsset[]
  policies           EventPolicies?
  ticketTypes        TicketType[]
  holds              Hold[]
  orders             Order[]
  tickets            Ticket[]
  promoCodes         PromoCode[]
  eventSeatmaps      EventSeatmap[]
  checkins           Checkin[]
  flags              Flag[]
  reviews            EventReview[]
  eventCreatorDrafts EventCreatorDraft[]

  @@index([orgId, status])
  @@index([visibility, publishAt])
  @@index([startAt])
  @@index([status, publishAt])
  @@index([latitude, longitude])
  @@map("events")
}

model EventOccurrence {
  id         String    @id @default(cuid())
  eventId    String    @map("event_id")
  startsAt   DateTime  @map("starts_at")
  endsAt     DateTime  @map("ends_at")
  gateOpenAt DateTime? @map("gate_open_at")

  // Relations
  event   Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)
  orders  Order[]
  tickets Ticket[]
  holds   Hold[]

  @@index([eventId, startsAt])
  @@map("event_occurrences")
}

model EventAsset {
  id        String   @id @default(cuid())
  eventId   String   @map("event_id")
  kind      String // 'image','pdf','video','seatmap-render'
  url       String
  altText   String?  @map("alt_text")
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  event Event @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@index([eventId])
  @@map("event_assets")
}

model EventPolicies {
  eventId         String  @id @map("event_id")
  refundPolicy    String? @map("refund_policy")
  transferAllowed Boolean @default(true) @map("transfer_allowed")
  transferCutoff  String? // Interval, e.g., '2 hours' @map("transfer_cutoff")
  resaleAllowed   Boolean @default(false) @map("resale_allowed")

  // Relations
  event Event @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@map("event_policies")
}

// ---------- Reviews ----------
model EventReview {
  id        String   @id @default(cuid())
  eventId   String   @map("event_id")
  userId    String   @map("user_id")
  rating    Int
  comment   String?
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  event Event @relation(fields: [eventId], references: [id], onDelete: Cascade)
  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([eventId, userId])
  @@index([eventId])
  @@index([userId])
  @@map("event_reviews")
}

model OrganizerReview {
  id        String   @id @default(cuid())
  orgId     String   @map("org_id")
  userId    String   @map("user_id")
  rating    Int
  comment   String?
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([orgId, userId])
  @@index([orgId])
  @@index([userId])
  @@map("organizer_reviews")
}

// ---------- Ticketing & Pricing ----------
model TicketType {
  id            String     @id @default(cuid())
  eventId       String     @map("event_id")
  name          String
  kind          TicketKind
  currency      String
  priceCents    BigInt     @map("price_cents")
  feeCents      BigInt     @default(0) @map("fee_cents")
  capacity      Int?
  perOrderLimit Int?       @map("per_order_limit")
  salesStart    DateTime?  @map("sales_start")
  salesEnd      DateTime?  @map("sales_end")
  status        String     @default("active")
  sortOrder     Int        @default(0) @map("sort_order")
  deletedAt     DateTime?  @map("deleted_at")

  // Relations
  event           Event             @relation(fields: [eventId], references: [id], onDelete: Cascade)
  priceTiers      TicketPriceTier[]
  ticketTypeSeats TicketTypeSeat[]
  orderItems      OrderItem[]
  holds           Hold[]
  tickets         Ticket[]

  @@index([eventId])
  @@index([status, salesStart, salesEnd])
  @@map("ticket_types")
}

model TicketPriceTier {
  id           String    @id @default(cuid())
  ticketTypeId String    @map("ticket_type_id")
  startsAt     DateTime? @map("starts_at")
  endsAt       DateTime? @map("ends_at")
  minQty       Int       @default(1) @map("min_qty")
  priceCents   BigInt    @map("price_cents")
  feeCents     BigInt    @default(0) @map("fee_cents")

  // Relations
  ticketType TicketType @relation(fields: [ticketTypeId], references: [id], onDelete: Cascade)

  @@unique([ticketTypeId, startsAt, endsAt])
  @@map("ticket_price_tiers")
}

model TicketTypeSeat {
  ticketTypeId String @map("ticket_type_id")
  seatId       String @map("seat_id")

  // Relations
  ticketType TicketType @relation(fields: [ticketTypeId], references: [id], onDelete: Cascade)
  seat       Seat       @relation(fields: [seatId], references: [id], onDelete: Cascade)

  @@id([ticketTypeId, seatId])
  @@map("ticket_type_seats")
}

model Hold {
  id           String     @id @default(cuid())
  eventId      String     @map("event_id")
  ticketTypeId String?    @map("ticket_type_id")
  seatId       String?    @map("seat_id")
  occurrenceId String?    @map("occurrence_id")
  userId       String?    @map("user_id")
  reason       HoldReason @default(checkout)
  quantity     Int        @default(1)
  expiresAt    DateTime   @map("expires_at")
  createdAt    DateTime   @default(now()) @map("created_at")

  // Relations
  event      Event            @relation(fields: [eventId], references: [id], onDelete: Cascade)
  ticketType TicketType?      @relation(fields: [ticketTypeId], references: [id], onDelete: Cascade)
  seat       Seat?            @relation(fields: [seatId], references: [id], onDelete: Cascade)
  occurrence EventOccurrence? @relation(fields: [occurrenceId], references: [id], onDelete: SetNull)
  user       User?            @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@unique([eventId, occurrenceId, seatId])
  @@unique([eventId, ticketTypeId, userId])
  @@index([eventId, expiresAt])
  @@index([expiresAt])
  @@map("holds")
}

// ---------- Orders, Payments, Tickets ----------
model Order {
  id              String      @id @default(cuid())
  buyerId         String      @map("buyer_id")
  orgId           String      @map("org_id")
  eventId         String      @map("event_id")
  occurrenceId    String?     @map("occurrence_id")
  status          OrderStatus @default(pending)
  subtotalCents   BigInt      @default(0) @map("subtotal_cents")
  feesCents       BigInt      @default(0) @map("fees_cents")
  taxCents        BigInt      @default(0) @map("tax_cents")
  totalCents      BigInt      @default(0) @map("total_cents")
  currency        String
  paymentIntentId String?     @map("payment_intent_id")
  createdAt       DateTime    @default(now()) @map("created_at")
  updatedAt       DateTime    @updatedAt @map("updated_at")
  paidAt          DateTime?   @map("paid_at")
  canceledAt      DateTime?   @map("canceled_at")

  // Relations
  buyer            User              @relation(fields: [buyerId], references: [id], onDelete: Restrict)
  org              Organization      @relation(fields: [orgId], references: [id], onDelete: Restrict)
  event            Event             @relation(fields: [eventId], references: [id], onDelete: Restrict)
  occurrence       EventOccurrence?  @relation(fields: [occurrenceId], references: [id], onDelete: SetNull)
  items            OrderItem[]
  taxLines         OrderTaxLine[]
  feeLines         OrderFeeLine[]
  payments         Payment[]
  tickets          Ticket[]
  refunds          Refund[]
  disputes         Dispute[]
  promoRedemptions PromoRedemption[]

  @@index([buyerId, createdAt(sort: Desc)])
  @@index([eventId, createdAt(sort: Desc)])
  @@index([status])
  @@map("orders")
}

model OrderItem {
  id             String  @id @default(cuid())
  orderId        String  @map("order_id")
  ticketTypeId   String  @map("ticket_type_id")
  seatId         String? @map("seat_id")
  quantity       Int
  unitPriceCents BigInt  @map("unit_price_cents")
  unitFeeCents   BigInt  @default(0) @map("unit_fee_cents")
  currency       String

  // Relations
  order      Order      @relation(fields: [orderId], references: [id], onDelete: Cascade)
  ticketType TicketType @relation(fields: [ticketTypeId], references: [id])
  seat       Seat?      @relation(fields: [seatId], references: [id])

  @@index([orderId])
  @@index([ticketTypeId])
  @@map("order_items")
}

model OrderTaxLine {
  id          String  @id @default(cuid())
  orderId     String  @map("order_id")
  name        String // 'Sales tax', 'VAT'
  rate        Decimal // e.g., 0.0725
  amountCents BigInt  @map("amount_cents")

  // Relations
  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@map("order_tax_lines")
}

model OrderFeeLine {
  id          String @id @default(cuid())
  orderId     String @map("order_id")
  name        String // 'Platform fee', 'Processing fee'
  amountCents BigInt @map("amount_cents")
  beneficiary String // 'platform' or 'organizer'

  // Relations
  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@map("order_fee_lines")
}

model Payment {
  id             String        @id @default(cuid())
  orderId        String        @map("order_id")
  provider       String // 'stripe','adyen', etc.
  providerIntent String?       @map("provider_intent")
  providerCharge String?       @map("provider_charge")
  status         PaymentStatus
  amountCents    BigInt        @map("amount_cents")
  currency       String
  capturedAt     DateTime?     @map("captured_at")
  failureCode    String?       @map("failure_code")
  failureMessage String?       @map("failure_message")
  createdAt      DateTime      @default(now()) @map("created_at")

  // Relations
  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@unique([provider, providerCharge])
  @@index([orderId])
  @@index([status])
  @@map("payments")
}

model Ticket {
  id              String       @id @default(cuid())
  orderId         String       @map("order_id")
  eventId         String       @map("event_id")
  occurrenceId    String?      @map("occurrence_id")
  ticketTypeId    String       @map("ticket_type_id")
  seatId          String?      @map("seat_id")
  ownerId         String       @map("owner_id")
  status          TicketStatus @default(issued)
  qrCode          String?      @unique @map("qr_code")
  barcode         String?
  issuedAt        DateTime     @default(now()) @map("issued_at")
  transferredFrom String?      @map("transferred_from")

  // Relations
  order         Order            @relation(fields: [orderId], references: [id], onDelete: Cascade)
  event         Event            @relation(fields: [eventId], references: [id], onDelete: Restrict)
  occurrence    EventOccurrence? @relation(fields: [occurrenceId], references: [id], onDelete: SetNull)
  ticketType    TicketType       @relation(fields: [ticketTypeId], references: [id])
  seat          Seat?            @relation(fields: [seatId], references: [id])
  owner         User             @relation(fields: [ownerId], references: [id])
  transfersFrom Transfer[]       @relation("TransferFrom")
  checkins      Checkin[]

  @@unique([eventId, occurrenceId, seatId])
  @@index([eventId, status])
  @@index([ownerId])
  @@map("tickets")
}

model Transfer {
  id          String    @id @default(cuid())
  ticketId    String    @map("ticket_id")
  fromUserId  String    @map("from_user_id")
  toUserId    String    @map("to_user_id")
  initiatedAt DateTime  @default(now()) @map("initiated_at")
  acceptedAt  DateTime? @map("accepted_at")
  canceledAt  DateTime? @map("canceled_at")

  // Relations
  ticket   Ticket @relation("TransferFrom", fields: [ticketId], references: [id], onDelete: Cascade)
  fromUser User   @relation("TransferFrom", fields: [fromUserId], references: [id])
  toUser   User   @relation("TransferTo", fields: [toUserId], references: [id])

  @@index([toUserId, initiatedAt(sort: Desc)])
  @@map("transfers")
}

model Checkin {
  id        String   @id @default(cuid())
  ticketId  String   @map("ticket_id")
  eventId   String   @map("event_id")
  scannerId String?  @map("scanner_id")
  gate      String?
  scannedAt DateTime @default(now()) @map("scanned_at")

  // Relations
  ticket Ticket @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  event  Event  @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@unique([ticketId])
  @@index([eventId, scannedAt(sort: Desc)])
  @@map("checkins")
}

// ---------- Promotions ----------
model Promotion {
  id             String   @id @default(cuid())
  orgId          String   @map("org_id")
  name           String
  description    String?
  type           String // 'discount', 'access', 'hold'
  discountType   String?  @map("discount_type") // 'percentage', 'fixed'
  discountValue  Int?     @map("discount_value") // percentage or cents
  currency       String?
  maxUses        Int      @default(0) @map("max_uses")
  maxUsesPerUser Int?     @map("max_uses_per_user")
  startsAt       DateTime @map("starts_at")
  endsAt         DateTime @map("ends_at")
  eventIds       String[] @map("event_ids")
  ticketTypeIds  String[] @default([]) @map("ticket_type_ids")
  minOrderAmount Int?     @map("min_order_amount") // in cents
  redemptions    Int      @default(0)
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  // Relations
  org        Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  promoCodes PromoCode[]

  @@index([orgId, startsAt])
  @@map("promotions")
}

model PromoCode {
  id             String    @id @default(cuid())
  orgId          String    @map("org_id")
  promotionId    String?   @map("promotion_id")
  eventId        String?   @map("event_id")
  code           String
  kind           String // 'percent','amount','access','hold'
  percentOff     Decimal?  @map("percent_off")
  amountOffCents BigInt?   @map("amount_off_cents")
  currency       String?
  maxRedemptions Int?      @map("max_redemptions")
  perUserLimit   Int?      @map("per_user_limit")
  startsAt       DateTime? @map("starts_at")
  endsAt         DateTime? @map("ends_at")
  createdAt      DateTime  @default(now()) @map("created_at")

  // Relations
  org         Organization      @relation(fields: [orgId], references: [id], onDelete: Cascade)
  promotion   Promotion?        @relation(fields: [promotionId], references: [id], onDelete: Cascade)
  event       Event?            @relation(fields: [eventId], references: [id], onDelete: Cascade)
  redemptions PromoRedemption[]

  @@unique([eventId, code])
  @@unique([orgId, code])
  @@index([promotionId])
  @@map("promo_codes")
}

model PromoRedemption {
  id         String   @id @default(cuid())
  promoId    String   @map("promo_id")
  orderId    String   @map("order_id")
  userId     String   @map("user_id")
  redeemedAt DateTime @default(now()) @map("redeemed_at")

  // Relations
  promo PromoCode @relation(fields: [promoId], references: [id], onDelete: Cascade)
  order Order     @relation(fields: [orderId], references: [id], onDelete: Cascade)
  user  User      @relation(fields: [userId], references: [id])

  @@index([promoId])
  @@index([userId])
  @@map("promo_redemptions")
}

// ---------- Refunds & Disputes ----------
model Refund {
  id          String       @id @default(cuid())
  orderId     String       @map("order_id")
  amountCents BigInt       @map("amount_cents")
  currency    String
  reason      String?
  status      RefundStatus @default(pending)
  createdBy   String?      @map("created_by")
  createdAt   DateTime     @default(now()) @map("created_at")
  processedAt DateTime?    @map("processed_at")
  providerRef String?      @map("provider_ref")

  // Relations
  order   Order @relation(fields: [orderId], references: [id], onDelete: Cascade)
  creator User? @relation(fields: [createdBy], references: [id])

  @@index([orderId, status])
  @@map("refunds")
}

model Dispute {
  id          String    @id @default(cuid())
  orderId     String    @map("order_id")
  provider    String
  caseId      String    @map("case_id")
  status      String // 'needs_response','won','lost','warning', etc.
  amountCents BigInt?   @map("amount_cents")
  reason      String?
  openedAt    DateTime  @default(now()) @map("opened_at")
  closedAt    DateTime? @map("closed_at")

  // Relations
  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@unique([provider, caseId])
  @@map("disputes")
}

// ---------- Moderation ----------
model Flag {
  id         String           @id @default(cuid())
  reporterId String?          @map("reporter_id")
  targetKind String           @map("target_kind") // 'user','organization','event','ticket'
  targetId   String           @map("target_id")
  reason     String?
  status     ModerationStatus @default(open)
  createdAt  DateTime         @default(now()) @map("created_at")
  resolvedAt DateTime?        @map("resolved_at")

  // Relations
  reporter User?  @relation(fields: [reporterId], references: [id], onDelete: SetNull)
  event    Event? @relation(fields: [targetId], references: [id])

  @@index([targetKind, targetId])
  @@index([status])
  @@map("flags")
}

model ModerationAction {
  id          String   @id @default(cuid())
  moderatorId String   @map("moderator_id")
  targetKind  String   @map("target_kind")
  targetId    String   @map("target_id")
  action      String // 'approve','reject','pause','unlist','suspend-user'
  notes       String?
  createdAt   DateTime @default(now()) @map("created_at")

  // Relations
  moderator User @relation(fields: [moderatorId], references: [id])

  @@map("moderation_actions")
}

// ---------- Settings, Tax, Fees ----------
model SiteSetting {
  key       String   @id
  value     Json
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("site_settings")
}

model TaxRate {
  id        String   @id @default(cuid())
  country   String
  region    String?
  city      String?
  postal    String?
  rate      Decimal // e.g., 0.0725
  name      String // 'Sales Tax', 'VAT'
  active    Boolean  @default(true)
  createdAt DateTime @default(now()) @map("created_at")

  @@map("tax_rates")
}

model FeeSchedule {
  id         String   @id @default(cuid())
  kind       String // 'platform','processing'
  name       String
  percent    Decimal  @default(0)
  fixedCents BigInt   @default(0) @map("fixed_cents")
  currency   String?
  active     Boolean  @default(true)
  createdAt  DateTime @default(now()) @map("created_at")

  // Relations
  orgFeeOverrides OrgFeeOverride[]

  @@map("fee_schedules")
}

model OrgFeeOverride {
  id            String    @id @default(cuid())
  orgId         String    @map("org_id")
  feeScheduleId String    @map("fee_schedule_id")
  startsAt      DateTime? @map("starts_at")
  endsAt        DateTime? @map("ends_at")

  // Relations
  org         Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  feeSchedule FeeSchedule  @relation(fields: [feeScheduleId], references: [id], onDelete: Cascade)

  @@map("org_fee_overrides")
}

// ---------- Webhooks & Integrations ----------
model WebhookEndpoint {
  id           String   @id @default(cuid())
  orgId        String?  @map("org_id")
  url          String
  secret       String
  eventFilters String[] @default([]) @map("event_filters")
  active       Boolean  @default(true)
  createdAt    DateTime @default(now()) @map("created_at")

  // Relations
  org      Organization?    @relation(fields: [orgId], references: [id], onDelete: Cascade)
  attempts WebhookAttempt[]

  @@map("webhook_endpoints")
}

model WebhookEvent {
  id        String   @id @default(cuid())
  topic     String // 'order.paid','ticket.checked_in', etc.
  payload   Json
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  attempts WebhookAttempt[]

  @@map("webhook_events")
}

model WebhookAttempt {
  id             String   @id @default(cuid())
  webhookEventId String   @map("webhook_event_id")
  endpointId     String   @map("endpoint_id")
  statusCode     Int?     @map("status_code")
  success        Boolean  @default(false)
  errorMessage   String?  @map("error_message")
  attemptedAt    DateTime @default(now()) @map("attempted_at")
  retryCount     Int      @default(0) @map("retry_count")

  // Relations
  webhookEvent WebhookEvent    @relation(fields: [webhookEventId], references: [id], onDelete: Cascade)
  endpoint     WebhookEndpoint @relation(fields: [endpointId], references: [id], onDelete: Cascade)

  @@index([endpointId, attemptedAt(sort: Desc)])
  @@map("webhook_attempts")
}

// ---------- Notifications ----------
enum NotificationType {
  info
  success
  warning
  error
}

enum NotificationChannel {
  in_app
  email
  push
  sms
}

enum NotificationCategory {
  order // New orders, order updates
  event // Event approvals, status changes
  payout // Payout notifications
  moderation // Flags, content moderation
  ticket // Ticket transfers, check-ins
  system // System announcements
  marketing // Promotional updates
}

enum NotificationFrequency {
  instant // Send immediately
  daily_digest // Once per day
  weekly_digest // Once per week
  disabled // Do not send
}

model Notification {
  id         String                @id @default(cuid())
  userId     String                @map("user_id")
  type       NotificationType      @default(info)
  category   NotificationCategory  @default(system)
  title      String
  message    String
  data       Json?
  channels   NotificationChannel[]
  readAt     DateTime?             @map("read_at")
  actionUrl  String?               @map("action_url") // Deep link for notification action
  actionText String?               @map("action_text") // Button text for action
  imageUrl   String?               @map("image_url") // Optional image/thumbnail
  createdAt  DateTime              @default(now()) @map("created_at")
  updatedAt  DateTime              @updatedAt @map("updated_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt(sort: Desc)])
  @@index([userId, readAt])
  @@index([userId, category])
  @@map("notifications")
}

model NotificationPreference {
  id        String                @id @default(cuid())
  userId    String                @map("user_id")
  category  NotificationCategory
  inApp     NotificationFrequency @default(instant) @map("in_app")
  email     NotificationFrequency @default(instant)
  push      NotificationFrequency @default(instant)
  sms       NotificationFrequency @default(disabled)
  createdAt DateTime              @default(now()) @map("created_at")
  updatedAt DateTime              @updatedAt @map("updated_at")

  // Relations
  user User @relation("NotificationPreferences", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, category])
  @@map("notification_preferences")
}

// ---------- Audit & Observability ----------
model AuditLog {
  id         String   @id @default(cuid())
  actorId    String?  @map("actor_id")
  action     String // 'create','update','delete','login', etc.
  targetKind String   @map("target_kind")
  targetId   String?  @map("target_id")
  meta       Json?
  createdAt  DateTime @default(now()) @map("created_at")

  // Relations
  actor User? @relation("AuditLogActor", fields: [actorId], references: [id])

  @@index([targetKind, targetId])
  @@index([actorId, createdAt(sort: Desc)])
  @@map("audit_logs")
}

enum EventCreatorDraftStatus {
  draft
  ready
  scheduled
  published
  archived
}

enum EventCreatorSectionType {
  basics
  story
  tickets
  schedule
  checkout
}

enum EventCreatorSectionStatus {
  incomplete
  valid
  blocked
}

enum EventCreatorEventType {
  in_person
  online
  hybrid
}

enum EventCreatorTicketKind {
  free
  paid
  donation
  hidden
  hold
}

enum EventCreatorTicketVisibility {
  public
  hidden
}

enum EventCreatorFeeMode {
  absorb
  pass_on
}

enum EventCreatorCollaboratorRole {
  owner
  editor
  finance
  check_in
}

enum EventCreatorScheduleType {
  single
  multi_day
  recurring
}

enum EventCreatorDiscountType {
  percent
  amount
  access
}

enum EventCreatorFormFieldType {
  text
  textarea
  select
  multiselect
  checkbox
  radio
  file
  phone
  email
  country
  state
  date
  time
}

model EventCreatorDraft {
  id                    String                   @id @default(cuid())
  eventId               String?                  @map("event_id")
  organizationId        String                   @map("organization_id")
  ownerUserId           String                   @map("owner_user_id")
  status                EventCreatorDraftStatus  @default(draft)
  eventType             EventCreatorEventType    @map("event_type")
  timezone              String
  visibility            Visibility               @default(public)
  title                 String?
  slug                  String?
  coverImageUrl         String?                  @map("cover_image_url")
  shortDescription      String?                  @map("short_description")
  completionPercent     Int                      @default(0) @map("completion_percent")
  activeSection         EventCreatorSectionType? @map("active_section")
  lastAutosavedAt       DateTime?                @map("last_autosaved_at")
  previewToken          String?                  @map("preview_token")
  previewTokenExpiresAt DateTime?                @map("preview_token_expires_at")
  targetPublishAt       DateTime?                @map("target_publish_at")
  createdAt             DateTime                 @default(now()) @map("created_at")
  updatedAt             DateTime                 @updatedAt @map("updated_at")

  // Relations
  organization   Organization                     @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  owner          User                             @relation("EventCreatorDraftOwner", fields: [ownerUserId], references: [id], onDelete: Cascade)
  event          Event?                           @relation(fields: [eventId], references: [id], onDelete: SetNull)
  sections       EventCreatorDraftSection[]
  versions       EventCreatorDraftVersion[]
  collaborators  EventCreatorDraftCollaborator[]
  scheduleRules  EventCreatorDraftScheduleRule[]
  venues         EventCreatorDraftVenue[]
  tickets        EventCreatorDraftTicketType[]
  taxFees        EventCreatorDraftTaxFee[]
  promoCodes     EventCreatorDraftPromoCode[]
  checkoutFields EventCreatorDraftCheckoutField[]

  @@index([organizationId])
  @@index([ownerUserId])
  @@index([status])
  @@index([updatedAt])
  @@map("event_creator_drafts")
}

model EventCreatorDraftSection {
  id          String                    @id @default(cuid())
  draftId     String                    @map("draft_id")
  section     EventCreatorSectionType
  status      EventCreatorSectionStatus @default(incomplete)
  payload     Json                      @default("{}")
  errors      Json?                     @default("[]")
  completedAt DateTime?                 @map("completed_at")
  createdAt   DateTime                  @default(now()) @map("created_at")
  updatedAt   DateTime                  @updatedAt @map("updated_at")

  // Relations
  draft EventCreatorDraft @relation(fields: [draftId], references: [id], onDelete: Cascade)

  @@unique([draftId, section])
  @@index([draftId, section, status])
  @@map("event_creator_draft_sections")
}

model EventCreatorDraftVersion {
  id        String                   @id @default(cuid())
  draftId   String                   @map("draft_id")
  section   EventCreatorSectionType?
  payload   Json
  createdBy String                   @map("created_by")
  reason    String?
  createdAt DateTime                 @default(now()) @map("created_at")

  // Relations
  draft  EventCreatorDraft @relation(fields: [draftId], references: [id], onDelete: Cascade)
  author User              @relation("EventCreatorDraftVersionAuthor", fields: [createdBy], references: [id], onDelete: Cascade)

  @@index([draftId, section])
  @@index([createdBy])
  @@map("event_creator_draft_versions")
}

model EventCreatorTemplate {
  id             String   @id @default(cuid())
  organizationId String   @map("organization_id")
  name           String
  description    String?
  coverImageUrl  String?  @map("cover_image_url")
  sections       Json     @default("{}")
  isDefault      Boolean  @default(false) @map("is_default")
  isActive       Boolean  @default(true) @map("is_active")
  createdBy      String   @map("created_by")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  // Relations
  organization Organization                 @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  creator      User                         @relation("EventCreatorTemplateAuthor", fields: [createdBy], references: [id], onDelete: Cascade)
  accesses     EventCreatorTemplateAccess[]

  @@index([organizationId])
  @@index([isActive])
  @@map("event_creator_templates")
}

model EventCreatorTemplateAccess {
  id         String                        @id @default(cuid())
  templateId String                        @map("template_id")
  userId     String?                       @map("user_id")
  role       EventCreatorCollaboratorRole?
  createdAt  DateTime                      @default(now()) @map("created_at")

  // Relations
  template EventCreatorTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)
  user     User?                @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([templateId])
  @@index([userId])
  @@map("event_creator_template_access")
}

model EventCreatorDraftCollaborator {
  id          String                       @id @default(cuid())
  draftId     String                       @map("draft_id")
  userId      String                       @map("user_id")
  role        EventCreatorCollaboratorRole @default(editor)
  permissions String[]                     @default([])
  invitedBy   String?                      @map("invited_by")
  createdAt   DateTime                     @default(now()) @map("created_at")

  // Relations
  draft EventCreatorDraft @relation(fields: [draftId], references: [id], onDelete: Cascade)
  user  User              @relation("EventCreatorDraftCollaboratorUser", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([draftId, userId])
  @@index([role])
  @@map("event_creator_draft_collaborators")
}

model EventCreatorDraftScheduleRule {
  id         String                   @id @default(cuid())
  draftId    String                   @map("draft_id")
  ruleType   EventCreatorScheduleType @map("rule_type")
  timezone   String
  startsAt   DateTime                 @map("starts_at")
  endsAt     DateTime?                @map("ends_at")
  rrule      String?
  exceptions Json?                    @default("[]")
  metadata   Json?                    @default("{}")
  createdAt  DateTime                 @default(now()) @map("created_at")
  updatedAt  DateTime                 @updatedAt @map("updated_at")

  // Relations
  draft       EventCreatorDraft                     @relation(fields: [draftId], references: [id], onDelete: Cascade)
  occurrences EventCreatorDraftScheduleOccurrence[]

  @@index([draftId])
  @@map("event_creator_draft_schedule_rules")
}

model EventCreatorDraftScheduleOccurrence {
  id               String    @id @default(cuid())
  scheduleRuleId   String    @map("schedule_rule_id")
  startsAt         DateTime  @map("starts_at")
  endsAt           DateTime? @map("ends_at")
  capacityOverride Int?      @map("capacity_override")
  doorTime         DateTime? @map("door_time")
  venueId          String?   @map("venue_id")
  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt        DateTime  @updatedAt @map("updated_at")

  // Relations
  scheduleRule EventCreatorDraftScheduleRule @relation(fields: [scheduleRuleId], references: [id], onDelete: Cascade)
  venue        EventCreatorDraftVenue?       @relation(fields: [venueId], references: [id], onDelete: SetNull)

  @@index([scheduleRuleId])
  @@map("event_creator_draft_schedule_occurrences")
}

model EventCreatorDraftVenue {
  id           String                @id @default(cuid())
  draftId      String                @map("draft_id")
  mode         EventCreatorEventType
  label        String?
  placeId      String?               @map("place_id")
  address      Json?
  onlineUrl    String?               @map("online_url")
  instructions String?
  timezone     String?
  mapSnapshot  String?               @map("map_snapshot")
  metadata     Json?                 @default("{}")
  createdAt    DateTime              @default(now()) @map("created_at")
  updatedAt    DateTime              @updatedAt @map("updated_at")

  // Relations
  draft       EventCreatorDraft                     @relation(fields: [draftId], references: [id], onDelete: Cascade)
  occurrences EventCreatorDraftScheduleOccurrence[]

  @@index([draftId])
  @@map("event_creator_draft_venues")
}

model EventCreatorDraftTicketType {
  id                 String                       @id @default(cuid())
  draftId            String                       @map("draft_id")
  kind               EventCreatorTicketKind       @default(paid)
  name               String
  description        String?
  currency           String                       @default("USD")
  priceCents         BigInt?                      @map("price_cents")
  feeMode            EventCreatorFeeMode          @default(pass_on) @map("fee_mode")
  quantity           Int?
  quantitySold       Int?                         @default(0) @map("quantity_sold")
  salesStart         DateTime?                    @map("sales_start")
  salesEnd           DateTime?                    @map("sales_end")
  perOrderMin        Int?                         @default(1) @map("per_order_min")
  perOrderMax        Int?                         @map("per_order_max")
  visibility         EventCreatorTicketVisibility @default(public)
  accessCodeRequired Boolean                      @default(false) @map("access_code_required")
  waitlistEnabled    Boolean                      @default(false) @map("waitlist_enabled")
  seatMode           String?                      @map("seat_mode")
  metadata           Json?                        @default("{}")
  sortOrder          Int                          @default(0) @map("sort_order")
  createdAt          DateTime                     @default(now()) @map("created_at")
  updatedAt          DateTime                     @updatedAt @map("updated_at")

  // Relations
  draft  EventCreatorDraft              @relation(fields: [draftId], references: [id], onDelete: Cascade)
  addons EventCreatorDraftTicketAddon[]

  @@index([draftId])
  @@map("event_creator_draft_ticket_types")
}

model EventCreatorDraftTicketAddon {
  id           String   @id @default(cuid())
  ticketTypeId String   @map("ticket_type_id")
  name         String
  description  String?
  priceCents   BigInt?  @map("price_cents")
  quantity     Int?
  sortOrder    Int      @default(0) @map("sort_order")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Relations
  ticketType EventCreatorDraftTicketType @relation(fields: [ticketTypeId], references: [id], onDelete: Cascade)

  @@index([ticketTypeId])
  @@map("event_creator_draft_ticket_addons")
}

model EventCreatorDraftTaxFee {
  id         String   @id @default(cuid())
  draftId    String   @map("draft_id")
  region     String
  taxType    String   @map("tax_type")
  rate       Decimal? @db.Decimal(7, 4)
  absorbFees Boolean  @default(false) @map("absorb_fees")
  appliesTo  Json?    @default("{}") @map("applies_to")
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  // Relations
  draft EventCreatorDraft @relation(fields: [draftId], references: [id], onDelete: Cascade)

  @@index([draftId])
  @@map("event_creator_draft_tax_fees")
}

model EventCreatorDraftPromoCode {
  id               String                       @id @default(cuid())
  draftId          String                       @map("draft_id")
  code             String
  discountType     EventCreatorDiscountType     @map("discount_type")
  amountOff        BigInt?                      @map("amount_off")
  percentOff       Decimal?                     @map("percent_off") @db.Decimal(5, 2)
  usageLimit       Int?                         @map("usage_limit")
  usageCount       Int                          @default(0) @map("usage_count")
  perCustomerLimit Int?                         @map("per_customer_limit")
  startsAt         DateTime?                    @map("starts_at")
  endsAt           DateTime?                    @map("ends_at")
  appliesTo        Json?                        @default("[]") @map("applies_to")
  accessType       EventCreatorTicketVisibility @default(public) @map("access_type")
  createdAt        DateTime                     @default(now()) @map("created_at")
  updatedAt        DateTime                     @updatedAt @map("updated_at")

  // Relations
  draft EventCreatorDraft @relation(fields: [draftId], references: [id], onDelete: Cascade)

  @@unique([draftId, code])
  @@index([draftId])
  @@index([code])
  @@map("event_creator_draft_promo_codes")
}

model EventCreatorDraftCheckoutField {
  id          String                    @id @default(cuid())
  draftId     String                    @map("draft_id")
  fieldKey    String                    @map("field_key")
  label       String
  fieldType   EventCreatorFormFieldType @map("field_type")
  description String?
  required    Boolean                   @default(false)
  appliesTo   Json?                     @default("[]") @map("applies_to")
  options     Json?                     @default("[]")
  sortOrder   Int                       @default(0) @map("sort_order")
  createdAt   DateTime                  @default(now()) @map("created_at")
  updatedAt   DateTime                  @updatedAt @map("updated_at")

  // Relations
  draft EventCreatorDraft @relation(fields: [draftId], references: [id], onDelete: Cascade)

  @@unique([draftId, fieldKey])
  @@index([draftId])
  @@map("event_creator_draft_checkout_fields")
}

// ============================================================================
// CURRENCY MANAGEMENT SYSTEM
// ============================================================================

model CurrencyConfiguration {
  id String @id @default(cuid())

  // Basic currency settings
  defaultCurrency     String   @default("NGN")
  supportedCurrencies String[] @default(["NGN", "USD", "GBP", "EUR", "GHS", "KES", "ZAR"])

  // Multi-currency mode toggle
  multiCurrencyEnabled Boolean @default(false) @map("multi_currency_enabled")

  // Currency display settings
  currencySymbol     String @default("")
  currencyPosition   String @default("before") // "before" or "after"
  decimalSeparator   String @default(".") @map("decimal_separator")
  thousandsSeparator String @default(",") @map("thousands_separator")
  decimalPlaces      Int    @default(2) @map("decimal_places")

  // Exchange rate settings
  exchangeRatesEnabled Boolean   @default(false) @map("exchange_rates_enabled")
  exchangeRateProvider String?   @map("exchange_rate_provider") // "manual", "api", etc.
  exchangeRateApiKey   String?   @map("exchange_rate_api_key")
  lastRateUpdate       DateTime? @map("last_rate_update")
  autoUpdateRates      Boolean   @default(false) @map("auto_update_rates")
  updateFrequency      String    @default("daily") @map("update_frequency") // "hourly", "daily", "weekly"

  // Organizer preferences (for multi-currency mode)
  allowOrganizerCurrency Boolean @default(false) @map("allow_organizer_currency")

  // Audit
  updatedBy     String? @map("updated_by")
  updatedByUser User?   @relation(fields: [updatedBy], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("currency_configuration")
}

model ExchangeRate {
  id           String  @id @default(cuid())
  fromCurrency String  @map("from_currency") // e.g., "USD"
  toCurrency   String  @map("to_currency") // e.g., "NGN"
  rate         Decimal @db.Decimal(18, 6) // e.g., 1575.500000
  inverseRate  Decimal @db.Decimal(18, 6) // e.g., 0.000635 (1/rate)
  source       String  @default("manual") // "manual", "api", "system"
  provider     String? // API provider name if applicable

  // Validity period
  validFrom  DateTime  @default(now()) @map("valid_from")
  validUntil DateTime? @map("valid_until")
  isActive   Boolean   @default(true) @map("is_active")

  // Metadata
  metadata Json? @default("{}")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([fromCurrency, toCurrency, validFrom])
  @@index([fromCurrency, toCurrency, isActive])
  @@index([isActive, validFrom])
  @@map("exchange_rates")
}

model CurrencyChangeLog {
  id         String @id @default(cuid())
  changeType String @map("change_type") // "default_currency", "multi_currency_toggle", "exchange_rate"

  // Change details
  oldValue Json?   @map("old_value")
  newValue Json?   @map("new_value")
  reason   String?

  // Impact tracking
  affectedOrders Int? @default(0) @map("affected_orders")
  affectedEvents Int? @default(0) @map("affected_events")

  // Audit
  changedBy     String  @map("changed_by")
  changedByUser User    @relation(fields: [changedBy], references: [id], onDelete: Cascade)
  ipAddress     String? @map("ip_address")
  userAgent     String? @map("user_agent")

  createdAt DateTime @default(now()) @map("created_at")

  @@index([changeType, createdAt])
  @@index([changedBy])
  @@map("currency_change_logs")
}
